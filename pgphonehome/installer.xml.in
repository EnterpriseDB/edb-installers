<project>
    <!-- Package details -->
    <shortName>pgphonehome</shortName>
    <fullName>pgPhoneHome</fullName>
    <version>PG_VERSION_PGPHONEHOME-PG_BUILDNUM_PGPHONEHOME</version>
    
    <!-- These options are used on Windows -->
    <productDisplayName>${product_fullname} ${productVersion}</productDisplayName>
    <productComments>${product_fullname} ${productVersion} by EnterpriseDB</productComments>
    <productUrlHelpLink>http://www.enterprisedb.com</productUrlHelpLink>
    <productUrlInfoAbout>http://www.enterprisedb.com</productUrlInfoAbout>

    <!-- Windows Specific Options -->
    <startMenuGroupName>PostgreSQL</startMenuGroupName>
    
    <!-- The options are used for RPM registration -->
    <description>${product_fullname} ${productVersion} by EnterpriseDB</description>
    <summary>${msg(install.summary)}</summary>
    <vendor>EnterpriseDB</vendor>
    <release>1</release>

    <!-- Installer Size -->
    <width>550</width>
    <height>400</height>

    <!-- Misc package options -->
    <installerFilename>${product_shortname}-${product_version}-${platform_name}.${platform_exec_suffix}</installerFilename>
    <enableRollback>0</enableRollback>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>
    <saveRelativePaths>1</saveRelativePaths>
    <unattendedModeUI>minimal</unattendedModeUI>
    <outputDirectory>../output</outputDirectory>
    <uninstallerName>uninstall-${product_shortname}</uninstallerName>
    <uninstallerDirectory>${apachephpinstalldir}</uninstallerDirectory>
    <compressionAlgorithm>lzma</compressionAlgorithm>
    <installationLogFile>${system_temp_directory}/install-${product_shortname}.log</installationLogFile>

    
    <!-- Images -->
    <disableSplashScreen>1</disableSplashScreen>
    <leftImage>../resources/edb-side.png</leftImage>

    <!-- i18n files for the UI -->
    <customLanguageFileList>
        <language>
            <code>en</code>
            <encoding>iso8859-1</encoding>
            <file>i18n/en.lng</file>
        </language>
    </customLanguageFileList>
	
    <!-- Prebuild Actions -->
    <preBuildActionList>
      <setInstallerVariable name="originalplatform" value="${platform_name}"/>
      <setInstallerVariable name="originalplatform" value="linux-x32">
          <ruleList>
              <compareText text="${platform_name}" value="linux"/>
          </ruleList>
      </setInstallerVariable>
     </preBuildActionList>
	 
    <!-- Initialisation actions -->
    <initializationActionList>
	<setInstallerVariable name="productVersion" persist="1" value="PG_VERSION_PGPHONEHOME" />
	
	<!-- Abort Installation as trying to  run a 32-bit installer on 64-bit machine -->
        <throwError>
          <customErrorMessage>${msg(platform.not.match)}</customErrorMessage>
          <text>Unknown Error</text>
          <ruleList>
            <platformTest type="linux-x64"/>
            <compareText text="${originalplatform}" value="linux-x32"/>
          </ruleList>
        </throwError>
		
        <!-- Set the Apache Home -->
        <setInstallerVariable name="apachehome" value="">
            <persist>1</persist>
        </setInstallerVariable>
        <setInstallerVariable name="apacheport" value="8080">
            <persist>0</persist>
        </setInstallerVariable>
        
        <!-- Set the php Home -->
        <setInstallerVariable name="phphome" value="">
            <persist>0</persist>
        </setInstallerVariable>
        
        <!-- Set the pghost varaible to localhost -->
        <setInstallerVariable name="pghost" value="localhost">
            <persist>0</persist>
        </setInstallerVariable>

	<!-- Set the pgphonehome version(if exists) -->
        <setInstallerVariable name="pgphonehomeVersion" value="">
            <persist>0</persist>
        </setInstallerVariable>

        <!-- Set the default values -->
	
        <setInstallerVariable name="pgdatabase" value="postgres"/>	
        <setInstallerVariable name="defaultusername" value=""/>
        <setInstallerVariable name="defaultpasswd" value=""/>
        <setInstallerVariable name="defaultuser" value=""/>
        <setInstallerVariable name="defaultpassword" value=""/>

        <!-- ALL: Set the default values for unattended mode -->
        <actionGroup>
           <actionList>
                <setInstallerVariable name="defaultpasswd" value=""/>
                <setInstallerVariable name="defaultuser" value="postgres"/>
                <setInstallerVariable name="defaultpassword" value="postgres"/>
           </actionList>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${installer_ui}</text>
                    <value>unattended</value>
                </compareText>
           </ruleList>
        </actionGroup>


        <!-- WIN: Set the default values for unattended mode -->
        <actionGroup>
           <actionList>
        	<setInstallerVariable name="defaultusername" value="${env(USERNAME)}"/>
           </actionList>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${installer_ui}</text>
                    <value>unattended</value>
                </compareText>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
           </ruleList>
        </actionGroup>

        <!-- LINUX: Set the default values for unattended mode -->
        <actionGroup>
           <actionList>
                <setInstallerVariable name="defaultusername" value="${env(USERNAME)}"/>
           </actionList>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${installer_ui}</text>
                    <value>unattended</value>
                </compareText>
                <compareText>
                    <logic>contains</logic>
                    <text>${platform_name}</text>
                    <value>linux</value>
                </compareText>
           </ruleList>
        </actionGroup> 
 
        <!-- MAC: Set the default values for unattended mode -->
        <actionGroup>
           <actionList>
                <setInstallerVariable name="defaultusername" value="${env(USER)}"/>
           </actionList>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${installer_ui}</text>
                    <value>unattended</value>
                </compareText>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>osx</value>
                </compareText>
           </ruleList>
        </actionGroup>


    </initializationActionList>
    
    <!-- Preinstallation actions -->
    <preInstallationActionList>

        <!-- Check Previous Installation of pgphonehome -->
        <registryGet>
            <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgPhoneHome</key>
            <name>Version</name>
            <variable>pgphonehomeVersion</variable>
            <ruleList>
              <compareText>
                 <logic>equals</logic>
                 <text>${platform_name}</text>
                 <value>windows</value>
              </compareText>
           </ruleList>
        </registryGet>

        <iniFileGet>
           <file>/etc/postgres-reg.ini</file>
           <section>pgPhoneHome</section>
           <key>Version</key>
           <variable>pgphonehomeVersion</variable>
           <ruleList>
              <compareText>
                 <logic>does_not_equal</logic>
                 <text>${platform_name}</text>
                 <value>windows</value>
              </compareText>
           </ruleList>
        </iniFileGet> 

        <!-- WIN : Set the Apache Home , Php Home and Port(default 8080) from registry. ApachePhp Installation would have set these values -->
        <actionGroup>
            <actionList>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>APACHE_HOME</name>
                    <variable>apachehome</variable>
                </registryGet>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>APACHE_PORT</name>
                    <variable>apacheport</variable>
                </registryGet>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>PHP_HOME</name>
                    <variable>phphome</variable>
                </registryGet>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>Location</name>
                    <variable>apachephpinstalldir</variable>
                </registryGet>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        
        <!-- LINUX | MAC: Set the Apache Home , Php Home and Port(default 8080) from registry. ApachePhp Installation would have set these values -->
        <actionGroup>
          <actionList>
              <iniFileGet>
                  <file>/etc/postgres-reg.ini</file>  
                  <section>ApachePhp</section>
                  <key>APACHE_HOME</key>
                  <variable>apachehome</variable>
              </iniFileGet>
              <iniFileGet>
                  <file>/etc/postgres-reg.ini</file>  
                  <section>ApachePhp</section>
                  <key>APACHE_PORT</key>
                  <variable>apacheport</variable>
              </iniFileGet>
              <iniFileGet>
                  <file>/etc/postgres-reg.ini</file>  
                  <section>ApachePhp</section>
                  <key>PHP_HOME</key>
                  <variable>phphome</variable>
              </iniFileGet>
              <iniFileGet>
                  <file>/etc/postgres-reg.ini</file>
                  <section>ApachePhp</section>
                  <key>InstallationDirectory</key>
                  <variable>apachephpinstalldir</variable>
              </iniFileGet>
          </actionList>
          <ruleList>
              <compareText>
                  <logic>does_not_equal</logic>
                  <text>${platform_name}</text>
                  <value>windows</value>
              </compareText>
          </ruleList>
        </actionGroup>
        
        <!-- Abort Installation as Apache Home not found -->
        <actionGroup>
            <actionList>
                <throwError>
                    <customErrorMessage>${msg(error.apache.notfound)}</customErrorMessage>
                    <text>Unknown Error</text>
                </throwError>
            </actionList>
            <ruleList>
                <compareTextLength>
                    <length>0</length>
                    <logic>equals</logic>
                    <text>${apachehome}</text>
                </compareTextLength>
            </ruleList>
        </actionGroup>
        
        <!-- Abort Installation as php Home not found -->
        <actionGroup>
            <actionList>
                <throwError>
                    <customErrorMessage>${msg(error.php.notfound)}</customErrorMessage>
                    <text>Unknown Error</text>
                </throwError>
            </actionList>
            <ruleList>
                <compareTextLength>
                    <length>0</length>
                    <logic>equals</logic>
                    <text>${phphome}</text>
                </compareTextLength>
            </ruleList>
        </actionGroup>

        <setInstallerVariable>
              <name>apachehomedir</name>
              <value>${apachehome}</value>
              <persist>1</persist>
        </setInstallerVariable> 

        <!-- Ask user whether he wants to stop apache and continue -->
        <showQuestion>
           <text>${msg(apache.restart.question)}</text>
           <variable>response</variable>
           <ruleEvaluationLogic>or</ruleEvaluationLogic>
           <ruleList>
              <compareText>
                 <logic>equals</logic>
                 <text>${pgphonehomeVersion}</text>
                 <value/>
              </compareText>
              <fileTest>
                 <path>${apachehome}/conf/addons/application_secure.conf</path>
                 <condition>not_exists</condition>
              </fileTest> 
           </ruleList>
        </showQuestion>

        <!-- Exit the installation if the user selects 'no' -->
        <exit>
          <exitCode>0</exitCode>
          <ruleList>
              <compareText>
                 <logic>equals</logic>
                 <text>${response}</text>
                 <value>no</value>
              </compareText>
              <compareText>
                 <logic>equals</logic>
                 <text>${pgphonehomeVersion}</text>
                 <value/>
              </compareText>
           </ruleList>
        </exit>


        <!-- Lin | MAC :Stop the apache server -->
        <runProgram>
           <program>${apachehome}/bin/apachectl</program>
           <programArguments>"stop"</programArguments>
           <workingDirectory>${apachehome}/bin</workingDirectory>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.stop.apache)}</customErrorMessage>
           <abortOnError>1</abortOnError>
           <ruleList>
               <compareText>
                   <logic>does_not_equal</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </runProgram>

        <!-- WIN :Stop the apache server -->
        <stopWindowsService>
           <serviceName>EnterpriseDB ApachePHP</serviceName>
           <abortOnError>1</abortOnError>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.stop.apache)}</customErrorMessage>
           <ruleList>
               <compareText>
                   <logic>equals</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </stopWindowsService>

        <!-- WIN: Set the Installation Directory -->
        <setInstallerVariable name="installdir" value="${apachehome}\www">
            <persist>0</persist>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </setInstallerVariable>

        <!-- Linux | MAC:Set the Installation Directory -->
        <setInstallerVariable name="installdir" value="${apachehome}/www">
            <persist>0</persist>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </setInstallerVariable> 
        
        <!-- Creating back up of config file -->	
        <actionGroup>
            <actionList>
              <createBackupFile>
                <path>${installdir}/pgph/config.php</path>
              </createBackupFile>
              </actionList>
              <ruleList>
                <compareText>
                    <value></value>
                    <logic>does_not_equal</logic>
                    <text>${pgphonehomeVersion}</text>
                </compareText>
              </ruleList>
        </actionGroup>
        
        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfileslinux</folder>
            <destination>${system_temp_directory}</destination>
            <component>pgphonehome</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>linux</value>
                </compareText>
            </ruleList>
        </unpackDirectory>
        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfileslinux-x64</folder>
            <destination>${system_temp_directory}</destination>
            <component>pgphonehome</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>linux-x64</value>
                </compareText>
            </ruleList>
        </unpackDirectory>
        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfilesosx</folder>
            <destination>${system_temp_directory}</destination>
            <component>pgphonehome</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>osx</value>
                </compareText>
            </ruleList>
        </unpackDirectory>
        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfileswindows</folder>
            <destination>${system_temp_directory}</destination>
            <component>pgphonehome</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>windows</value>
                </compareText>
            </ruleList>
        </unpackDirectory>

        
    </preInstallationActionList>
    
    
    <!-- Post installation actions -->
    <postInstallationActionList>
        
        <actionGroup>
          <actionList>
            <deleteFile>
                <path>${installdir}/pgph/config.php</path>
            </deleteFile>		
            <renameFile>
                <origin>${installdir}/pgph/config.php.bak0</origin>
                <destination>${installdir}/pgph/config.php</destination>
            </renameFile>
            <deleteFile>
                <path>${installdir}/pgph/config.php.bak0</path>
            </deleteFile>		
          </actionList>
          <ruleList>
            <compareText>
              <value></value>
              <logic>does_not_equal</logic>
              <text>${pgphonehomeVersion}</text>
            </compareText>
          </ruleList>
        </actionGroup>
	
        <!-- Substitute Postgres Details in the conf file -->
        <actionGroup>
          <actionList>	
            <substitute>
              <files>${installdir}/pgph/config.php</files>
              <substitutionList>
                <substitution>
                    <pattern>@@HOST@@</pattern>
                    <value>${pghost}</value>
                </substitution>
                <substitution>
                    <pattern>@@PORT@@</pattern>
                    <value>${pgport}</value>
                </substitution>
                <substitution>
                    <pattern>@@USER@@</pattern>
                    <value>${pguser}</value>
                </substitution>
                <substitution>
                    <pattern>@@PASSWORD@@</pattern>
                    <value>${pgpassword}</value>
                </substitution>
              </substitutionList>
            </substitute>
          </actionList>
          <ruleList>
           <compareText>
                <text>${pgphonehomeVersion}</text>
                <logic>equals</logic>
                <value/>
            </compareText>
         </ruleList>		
	</actionGroup>
         
         <!-- WIN: Adding .htpasswd files -->
	 <actionGroup>
          <actionList>
            <runProgram>
		<program>${apachehome}\bin\htpasswd</program>
                <programArguments>"-bcs" "${env(APPDATA)}\pgphonehome.htpasswd" "${username}" "${password}" </programArguments>
                <workingDirectory>${apachehome}\bin</workingDirectory>
                <customErrorMessage>${msg(htpasswd.fail.error)}</customErrorMessage>
                <progressText>${msg(progress.passwd.file.create)}</progressText> 
                <showMessageOnError>1</showMessageOnError>
                <abortOnError>0</abortOnError>
            </runProgram>
            <showInfo>
                <text>${msg(pgphonehome.htpasswd.path.info.windows)}</text>
                <ruleList>
                    <fileExists>
                        <path>${env(APPDATA)}\pgphonehome.htpasswd</path>
                    </fileExists>
                </ruleList>
            </showInfo>  
          </actionList>
          <ruleList>
            <compareText>
                <text>${pgphonehomeVersion}</text>
                <logic>equals</logic>
                <value/>
            </compareText>
            <compareText>
                <logic>equals</logic>
                <text>${platform_name}</text>
                <value>windows</value>
            </compareText>
         </ruleList>
        </actionGroup>

        <!-- Setting the LD_LIBRARY_PATH variable -->
        <setEnvironmentVariable>
             <name>LD_LIBRARY_PATH</name>
             <value>${apachehome}/lib</value>
             <ruleList>
                <compareText>
                   <logic>does_not_equal</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
                </compareText> 
             </ruleList>
        </setEnvironmentVariable>  

         <!-- Linux | MAC: Adding .htpasswd files -->
         <actionGroup>
          <actionList>
            <runProgram>
                <program>${apachehome}/bin/htpasswd</program>
                <programArguments>"-bcs" "/etc/pgphonehome.htpasswd" "${username}" "${password}" </programArguments>
                <workingDirectory>${apachehome}/bin</workingDirectory>
                <progressText>${msg(progress.passwd.file.create)}</progressText> 
                <customErrorMessage>${msg(htpasswd.fail.error)}</customErrorMessage> 
                <showMessageOnError>1</showMessageOnError>
                <abortOnError>0</abortOnError>
            </runProgram>
            <showInfo>
                <text>${msg(pgphonehome.htpasswd.path.info)}</text>
                <ruleList>
                    <fileExists>
                        <path>/etc/pgphonehome.htpasswd</path>
                    </fileExists>
                </ruleList>
            </showInfo>  
          </actionList>
          <ruleList>
            <compareText>
                <text>${pgphonehomeVersion}</text>
                <logic>equals</logic>
                <value/>
            </compareText>
            <compareText>
                <logic>does_not_equal</logic>
                <text>${platform_name}</text>
                <value>windows</value>
            </compareText>
         </ruleList>
        </actionGroup> 

        <!-- LIN & MAC: Write the pgphonehome Info to INI File -->
        <actionGroup>
            <actionList>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>pgPhoneHome</section>
                    <key>Description</key>
                    <value>${msg(install.summary)}</value>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>pgPhoneHome</section>
                    <key>InstallationDirectory</key>
                    <value>${installdir}/pgph</value>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>pgPhoneHome</section>
                    <key>Version</key>
                    <value>${product_version}</value>
                </iniFileSet>
            </actionList>
            <ruleList>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>does_not_equal</logic>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>

       <!-- LIN| MAC: Finding whether the include line is already there in the httpd.conf file -->
       <setInstallerVariableFromScriptOutput>
          <exec>grep</exec>
          <execArgs>"include conf/addons/\*\.conf" "${apachehome}/conf/httpd.conf"</execArgs>
          <name>confText</name>
          <showMessageOnError>0</showMessageOnError>
            <abortOnError>0</abortOnError>
            <ruleList>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>does_not_equal</logic>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </setInstallerVariableFromScriptOutput>

        <!-- WIN: Finding whether the include line is already there in the httpd.conf file -->
        <setInstallerVariableFromScriptOutput>
          <exec>find</exec>
          <execArgs>"include conf\addons\*.conf" "${apachehome}\conf\httpd.conf"</execArgs>
          <name>confText</name>
          <showMessageOnError>0</showMessageOnError>
            <abortOnError>0</abortOnError>
            <ruleList>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>equals</logic>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </setInstallerVariableFromScriptOutput>
 
        <!-- WIN: Modifying the httpd.conf file -->
        <addTextToFile>
           <file>${apachehome}\conf\httpd.conf</file>
           <text>include conf\addons\*.conf</text>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${confText}</text>
                    <value/>
                </compareText>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
           </ruleList>
        </addTextToFile>

        <!-- Linux| MAC: Modifying the httpd.conf file -->
        <addTextToFile>
           <file>${apachehome}/conf/httpd.conf</file>
           <text>include conf/addons/*.conf</text>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${confText}</text>
                    <value/>
                </compareText>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
           </ruleList>
        </addTextToFile> 

        <createDirectory path="${apachehome}/conf/addons" >
           <ruleList>
              <fileTest>
	          <path>${apachehome}/conf/addons</path>
                  <condition>not_exists</condition>
              </fileTest>
           </ruleList>
        </createDirectory>

        <!-- Linux | MAC: Adding a application secure conf which prohibit directory listings of applications under www context -->
        <actionGroup>
           <actionList>
             <touchFile path="${apachehome}/conf/addons/application_secure.conf" />
             <addTextToFile>
                   <file>${apachehome}/conf/addons/application_secure.conf</file>
                   <text>
&lt;Directory "${apachehome}/www/*/scripts"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;

&lt;Directory "${apachehome}/www/*/installer"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;
                   </text>
             </addTextToFile>
           </actionList>
           <ruleList>
              <fileTest>
                 <path>${apachehome}/conf/addons/application_secure.conf</path>
                 <condition>not_exists</condition>
              </fileTest>
              <compareText>
                  <logic>does_not_equal</logic>
                  <text>${platform_name}</text>
                  <value>windows</value>
              </compareText>
          </ruleList>
        </actionGroup>

        <!-- WIN: Adding a application secure conf which prohibit directory listings of applications under www context -->
        <actionGroup>
           <actionList>
             <touchFile path="${apachehome}\conf\addons\application_secure.conf" />
             <addTextToFile>
                   <file>${apachehome}\conf\addons\application_secure.conf</file>
                   <text>
&lt;Directory "${apachehome}\www\*\scripts"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;

&lt;Directory "${apachehome}\www\*\installer"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;
                   </text>
             </addTextToFile>
           </actionList>
           <ruleList>
             <fileTest>
                 <path>${apachehome}\conf\addons\application_secure.conf</path>
                 <condition>not_exists</condition>
             </fileTest>
             <compareText>
                  <logic>equals</logic>
                  <text>${platform_name}</text>
                  <value>windows</value>
             </compareText>
           </ruleList>
        </actionGroup>

  
        <touchFile path="${apachehome}/conf/addons/${product_fullname}.conf" />

        <!-- WIN : Modifying the conf file -->
        <addTextToFile>
           <file>${apachehome}\conf\addons\${product_fullname}.conf</file>
           <text>
&lt;Directory "${apachehome}\www\pgph"&gt;
   AllowOverride All
   Options FollowSymLinks Includes
   # Securing website

   AuthType Basic
   AuthUserFile "${env(APPDATA)}\pgphonehome.htpasswd"
   AuthName ${product_fullname}

   require valid-user
   Order allow,deny
   Allow from all

&lt;/Directory&gt;
           </text>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
                <compareText>
                    <logic>equals</logic>
                    <text>${pgphonehomeVersion}</text>
                    <value/>
                </compareText>
           </ruleList>
        </addTextToFile>

        <!-- Linux | MAC : Modifying the conf file -->
        <addTextToFile>
           <file>${apachehome}/conf/addons/${product_fullname}.conf</file>
           <text>
&lt;Directory "${apachehome}/www/pgph"&gt;
   AllowOverride All
   Options FollowSymLinks Includes
   # Securing website

   AuthType Basic
   AuthUserFile /etc/pgphonehome.htpasswd
   AuthName ${product_fullname}

   require valid-user
   Order allow,deny
   Allow from all

&lt;/Directory&gt;
           </text>
           <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
                <compareText>
                    <logic>equals</logic>
                    <text>${pgphonehomeVersion}</text>
                    <value/>
                </compareText>
           </ruleList>
        </addTextToFile>
   
        <!-- Lin | MAC :Start the apache server -->
        <runProgram>
           <program>${apachehome}/bin/apachectl</program>
           <programArguments>"start"</programArguments>
           <workingDirectory>${apachehome}/bin</workingDirectory>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.stop.apache)}</customErrorMessage>
           <abortOnError>0</abortOnError>
           <ruleList>
               <compareText>
                   <logic>does_not_equal</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </runProgram>

        <!-- Getting the Version Installed minus the buildnum -->
        <setInstallerVariableFromRegEx>
            <name>pgphonehomeVersionInstalled</name>
            <text>${pgphonehomeVersion}</text>
            <pattern>([0-9]*)-[0-9]*$</pattern>
            <substitution>\1</substitution>
            <ruleList>
              <compareText>
                 <logic>does_not_equal</logic>
                 <text>${pgphonehomeVersion}</text>
                 <value/>
              </compareText>
            </ruleList>
        </setInstallerVariableFromRegEx>

        <!-- Upgrade From Old Windows Installation -->
        <actionGroup>
            <actionList>
                <registryDelete>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\pgPhoneHome ${pgphonehomeVersionInstalled}</key>
                </registryDelete>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${pgphonehomeVersion}</text>
                    <value/>
                </compareText>
            </ruleList>
        </actionGroup>

        <!-- WIN :Start the apache server -->
        <startWindowsService>
           <serviceName>EnterpriseDB ApachePHP</serviceName>
           <abortOnError>1</abortOnError>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.start.apache)}</customErrorMessage>
           <ruleList>
               <compareText>
                   <logic>equals</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </startWindowsService>

        <showInfo>
             <text>${msg(pgphonehome.url.info)}</text>
        </showInfo>
        <deleteFile>
            <path>${installdir}/pgph/instscripts</path>
        </deleteFile>
        <deleteFile>
            <path>${system_temp_directory}/instscripts</path>
        </deleteFile>

    </postInstallationActionList>

    <!-- finalPage actions -->
    <finalPageActionList>
        <launchBrowser>
            <url>http://www.enterprisedb.com/installer/phonehome.do</url>
            <progressText>${msg(Installer.Installation.Finished.Visit.Us)}</progressText>
        </launchBrowser>
    </finalPageActionList>
	
    <preUninstallationActionList>

        <!-- Delete the .htaccess file created during installation -->
        <deleteFile>
           <path>${apachehomedir}/www/pgph/.htaccess</path>
        </deleteFile>  

        <!-- Linux | MAC : Delete the .htpasswd file --> 
        <deleteFile>
           <path>/etc/pgph</path>
           <ruleList>
               <compareText>
                   <logic>does_not_equal</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <fileExists>
                   <path>/etc/pgph</path>
               </fileExists>
           </ruleList> 
        </deleteFile> 

        <!-- WIN : Delete the .htpasswd file --> 
        <deleteFile>
           <path>${env(APPDATA)}\pgph</path>
           <ruleList>
               <compareText>
                   <logic>equals</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <fileExists>
                   <path>${env(APPDATA)}\pgph</path>
               </fileExists>
           </ruleList> 
        </deleteFile>  

        <!-- Delete the addon config added during installation -->
        <deleteFile>
           <path>${apachehomedir}/conf/addons/${product_fullname}.conf</path>
        </deleteFile>

        <!-- Unset the pgphonehome info from ini file -->
        <actionGroup>
            <actionList>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>pgPhoneHome</section>
                    <key>Description</key>
                    <value/>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>pgPhoneHome</section>
                    <key>InstallationDirectory</key>
                    <value/>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>pgPhoneHome</section>
                    <key>Version</key>
                    <value/>
                </iniFileSet>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
      
    </preUninstallationActionList>
    
    <!-- Components -->
    <componentList>
        <component>
            <name>pgphonehome</name>
            <description>pgphonehome</description>
            <canBeEdited>0</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <folderList>
              
                <!-- WIN: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/windows/pgph</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>

                <!-- WIN: Installation files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}/pgph</destination>
                    <name>installfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/windows/installer</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>staging/windows/instscripts</origin>
                        </distributionDirectory> 
                    </distributionFileList>
                </folder>
   
                <!-- Linux: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileslinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux/pgph</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>

                <!-- Linux: Installation files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}/pgph</destination>
                    <name>installfileslinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux/installer</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>staging/linux/instscripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>

                <!-- Linux-x64: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileslinux-x64</name>
                    <platforms>linux-x64</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux-x64/pgph</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>

                <!-- Linux-x64: Installation files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}/pgph</destination>
                    <name>installfileslinux-x64</name>
                    <platforms>linux-x64</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux-x64/installer</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>staging/linux-x64/instscripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
   
                <!-- MAC: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfilesosx</name>
                    <platforms>osx</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/osx/pgph</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>

                <!-- MAC: Installation files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}/pgph</destination>
                    <name>installfilesosx</name>
                    <platforms>osx</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/osx/installer</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>staging/osx/instscripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
 
            </folderList>
        </component>
    </componentList>
    <parameterList>
	<!-- pgphonehome User and Password Details -->
	<parameterGroup>
	    <name>pgphonehomedetails</name>
            <title>${msg(pgphonehome.details.title)}</title>
            <explanation>${msg(pgphonehome.details.explanation)}</explanation>
            <value/>
            <default/>
            <parameterList>
                <!-- pgphonehome User -->
                <stringParameter>
                    <name>username</name>
                    <description>Username</description>
                    <explanation></explanation>
                    <value/>
                    <default>${defaultusername}</default>
                    <allowEmptyValue>0</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
		 <!-- pgphonehome Password -->
                <passwordParameter>
                    <name>password</name>
                    <title>Password</title>
                    <description>Password</description>
                    <explanation></explanation>
                    <value/>
                    <default>${defaultpasswd}</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <askForConfirmation>1</askForConfirmation>
                    <descriptionRetype>Confirm Password</descriptionRetype>
                    <width>40</width>
                </passwordParameter>
	     </parameterList>
	     <ruleList>
                <compareText>
                  <text>${pgphonehomeVersion}</text>
                  <logic>equals</logic>
                  <value/>
                </compareText>
             </ruleList>
	  </parameterGroup>

        <!-- PostgreSQL Server Details Verification Page -->
        <parameterGroup>
            <name>pgdetails</name>
            <title>${msg(pgplus.details.title)}</title>
            <explanation>${msg(pgplus.details.explanation)}</explanation>
            <value/>
            <default/>
            <parameterList>
                <!-- Postgres Host(Default localhost) -->
                <stringParameter>
                    <name>pghost</name>
                    <description>Host</description>
                    <explanation></explanation>
                    <value/>
                    <default/>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                
                <!-- Postgres Port(Default 6543) -->
                <stringParameter>
                    <name>pgport</name>
                    <description>Port</description>
                    <explanation></explanation>
                    <value/>
                    <default>5432</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                
                <!-- Postgres User -->
                <stringParameter>
                    <name>pguser</name>
                    <description>User Name</description>
                    <explanation></explanation>
                    <value/>
                    <default/>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                
                <!-- Postgres User Password -->
                <passwordParameter>
                    <name>pgpassword</name>
                    <title>Password</title>
                    <description>Password</description>
                    <explanation></explanation>
                    <value/>
                    <default/>
                    <allowEmptyValue>1</allowEmptyValue>
                    <askForConfirmation>0</askForConfirmation>
                    <descriptionRetype></descriptionRetype>
                    <width>40</width>
                </passwordParameter>
                
                <!-- Default database-->
                <stringParameter>
                    <name>pgdatabase</name>
                    <description>Default Database</description>
                    <explanation/>
                    <value/>
                    <cliOptionName>dbname</cliOptionName>
                    <default>postgres</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                    <ask>0</ask>
                </stringParameter>
                
                <!-- PostgreSQL Server Installed? -->
                <booleanParameter>
                    <name>pginstalled</name>
                    <description>PostgreSQL Installed</description>
                    <explanation></explanation>
                    <value>${pginstalled}</value>
                    <default>0</default>
                    <ask>0</ask>
                    <displayStyle>checkbox-right</displayStyle>
                </booleanParameter>
            </parameterList>
	    <ruleList>
                <compareText>
                  <text>${pgphonehomeVersion}</text>
                  <logic>equals</logic>
                  <value/>
                </compareText>
             </ruleList>	
	    <!-- Checking the validity of PostgreSQL Server Details -->
	    <validationActionList>

               <actionGroup>
                   <actionList>
                        <throwError>
                             <text>${msg(pgplus.blank.error)}</text>
                        </throwError>
                   </actionList>
                   <ruleEvaluationLogic>or</ruleEvaluationLogic>
                   <ruleList>
                        <compareText>
                           <text>${pghost}</text>
                           <logic>equals</logic>
                           <value/>
                        </compareText>
                        <compareText>
                           <text>${pgport}</text>
                           <logic>equals</logic>
                           <value/>
                        </compareText>
                        <compareText>
                           <text>${pguser}</text>
                           <logic>equals</logic>
                           <value/>
                        </compareText>
                  </ruleList>
             </actionGroup>

	       <!-- Creating a temporary directory -->
                <createDirectory path="${system_temp_directory}/${product_fullname}"/>
                <!-- WIN: Unpacking the Script file to temporary directory -->
                <unpackFile>
                    <component>pgphonehome</component>
                    <destination>${system_temp_directory}/${product_fullname}/check-connection.bat</destination>
                    <folder>installfileswindows</folder>
                    <origin>installer/pgph/check-connection.bat</origin>
                    <ruleList>
                        <compareText>
                            <logic>equals</logic>
                            <text>${platform_name}</text>
                            <value>windows</value>
                        </compareText>
                    </ruleList>    					
                </unpackFile>

                <!-- Linux: Unpacking the Script file to temporary directory -->
                <unpackFile>
                    <component>pgphonehome</component>
                    <destination>${system_temp_directory}/${product_fullname}/check-connection.sh</destination>
                    <folder>installfileslinux</folder>
                    <origin>installer/pgph/check-connection.sh</origin>
                    <ruleList>
                        <compareText>
                            <logic>equals</logic>
                            <text>${platform_name}</text>
                            <value>linux</value>
                        </compareText>
                    </ruleList>
                </unpackFile>

                <!-- Linux-x64: Unpacking the Script file to temporary directory -->
                <unpackFile>
                    <component>pgphonehome</component>
                    <destination>${system_temp_directory}/${product_fullname}/check-connection.sh</destination>
                    <folder>installfileslinux-x64</folder>
                    <origin>installer/pgph/check-connection.sh</origin>
                    <ruleList>
                        <compareText>
                            <logic>equals</logic>
                            <text>${platform_name}</text>
                            <value>linux-x64</value>
                        </compareText>
                    </ruleList>
                </unpackFile>

                <!-- MAC: Unpacking the Script file to temporary directory -->
                <unpackFile>
                    <component>pgphonehome</component>
                    <destination>${system_temp_directory}/${product_fullname}/check-connection.sh</destination>
                    <folder>installfilesosx</folder>
                    <origin>installer/pgph/check-connection.sh</origin>
                    <ruleList>
                        <compareText>
                            <logic>equals</logic>
                            <text>${platform_name}</text>
                            <value>osx</value>
                        </compareText>
                    </ruleList>
                </unpackFile>   

                <!-- WIN: Running the Script to validate the PostgreSQL Server Details -->
                <setInstallerVariableFromScriptOutput>
                        <exec>${system_temp_directory}\${product_fullname}\check-connection.bat</exec>
                        <execArgs>${pghost} ${pgport} ${pguser} "${pgpassword}" "${system_temp_directory}\instscripts" "${pgdatabase}"</execArgs>
                        <name>connection</name>
                        <workingDirectory>${system_temp_directory}\${product_fullname}</workingDirectory>
                        <abortOnError>0</abortOnError>
                        <showMessageOnError>0</showMessageOnError>
                        <ruleList>
                        <compareText>
                            <logic>equals</logic>
                            <text>${platform_name}</text>
                            <value>windows</value>
                        </compareText>
                    </ruleList>
                </setInstallerVariableFromScriptOutput>
                <actionGroup>
                    <actionList>
                        <setInstallerVariable name="pgdatabase" value="edb" />
                        <!-- Running the Script to validate the PostgreSQL Server Details -->
                        <setInstallerVariableFromScriptOutput>
                            <exec>${system_temp_directory}/${product_fullname}/check-connection.bat</exec>
                            <execArgs>${pghost} ${pgport} ${pguser} "${pgpassword}" "${system_temp_directory}\instscripts" "${pgdatabase}"</execArgs>
                            <name>connection</name>
                            <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
                            <abortOnError>0</abortOnError>
                            <showMessageOnError>0</showMessageOnError>
                        </setInstallerVariableFromScriptOutput>
                    </actionList>
                    <ruleList>
                        <compareText>
                            <logic>equals</logic>
                            <text>${platform_name}</text>
                            <value>windows</value>
                        </compareText>
                        <compareText>
                            <logic>equals</logic>
                            <text>${connection}</text>
                            <value/>
                        </compareText>
                    </ruleList>
                </actionGroup>
       
                <!-- Linux | MAC: Running the Script to validate the PostgreSQL Server Details -->
                <setInstallerVariableFromScriptOutput>
                        <exec>${system_temp_directory}/${product_fullname}/check-connection.sh</exec>
                        <execArgs>${pghost} ${pgport} ${pguser} "${pgpassword}" "${system_temp_directory}/instscripts" "${pgdatabase}"</execArgs>
                        <name>connection</name>
                        <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
                        <abortOnError>0</abortOnError>
                        <showMessageOnError>0</showMessageOnError>
                        <ruleList>
                        <compareText>
                            <logic>does_not_equal</logic>
                            <text>${platform_name}</text>
                            <value>windows</value>
                        </compareText>
                    </ruleList>
                </setInstallerVariableFromScriptOutput>
                <actionGroup>
                    <actionList>
                        <setInstallerVariable name="pgdatabase" value="edb" />
                        <!-- Running the Script to validate the PostgreSQL Server Details -->
                        <setInstallerVariableFromScriptOutput>
                            <exec>${system_temp_directory}/${product_fullname}/check-connection.sh</exec>
                            <execArgs>${pghost} ${pgport} ${pguser} "${pgpassword}" "${system_temp_directory}/instscripts" "${pgdatabase}"</execArgs>
                            <name>connection</name>
                            <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
                            <abortOnError>0</abortOnError>
                            <showMessageOnError>0</showMessageOnError>
                        </setInstallerVariableFromScriptOutput>
                    </actionList>
                    <ruleList>
                        <compareText>
                            <logic>does_not_equal</logic>
                            <text>${platform_name}</text>
                            <value>windows</value>
                        </compareText>
                        <compareText>
                            <logic>equals</logic>
                            <text>${connection}</text>
                            <value/>
                        </compareText>
                    </ruleList>
                </actionGroup>

                <actionGroup>
                    <actionList>
                        <setInstallerVariable name="pgdatabase" value="postgres" />
                        <showWarning>
                             <text>${program_stderr}</text>
                        </showWarning> 
                        <setInstallerVariable>
                             <name>next_page</name>
                             <value>pgdetails</value>
                        </setInstallerVariable> 
                    </actionList>
                    <ruleList>
                        <compareText>
                            <logic>equals</logic>
                            <text>${connection}</text>
                            <value/>
                        </compareText>
                    </ruleList>
                </actionGroup>
                 
            </validationActionList>
             
        </parameterGroup>
    </parameterList>
</project>
