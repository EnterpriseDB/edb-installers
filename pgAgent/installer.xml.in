<project>

  <!-- Package details -->
  <shortName>pgagent</shortName>
  <fullName>pgAgent</fullName>
  <version>PG_VERSION_PGAGENT-PG_BUILDNUM_PGAGENT</version>

  <!-- product Specific Options -->
  <productComments>${product_fullname} ${productVersion}, packaged by EnterpriseDB</productComments>
  <productDisplayName>${product_fullname} ${productVersion}</productDisplayName>
  <productUrlHelpLink>http://www.enterprisedb.com</productUrlHelpLink>
  <productUrlInfoAbout>http://www.enterprisedb.com</productUrlInfoAbout>
  <startMenuGroupName></startMenuGroupName>

  <!-- The options are used for RPM registration -->
  <description>${product_shortname} ${productVersion}, packaged by EnterpriseDB</description>
  <summary>${msg(install.summary)}</summary>
  <vendor>EnterpriseDB</vendor>
  <release>1</release>

  <!-- Installer Size -->
  <width>550</width>
  <height>400</height>

  <!-- Misc options -->
  <installerFilename>${product_shortname}-${product_version}-${platform_name}.${platform_exec_suffix}</installerFilename>
  <compressionAlgorithm>lzma</compressionAlgorithm>
  <enableRollback>0</enableRollback>
  <requireInstallationByRootUser>1</requireInstallationByRootUser>
  <saveRelativePaths>1</saveRelativePaths>
  <outputDirectory>../output</outputDirectory>
  <unattendedModeUI>minimal</unattendedModeUI>
  <uninstallerName>uninstall-${product_shortname}</uninstallerName>
  <uninstallerDirectory>${installdir}</uninstallerDirectory>
  <installationLogFile>${system_temp_directory}/install-${product_shortname}.log</installationLogFile>

  <!-- Images -->
  <disableSplashScreen>1</disableSplashScreen>
  <leftImage>../resources/pg-side.png</leftImage>

  <!-- i18n files for the UI -->
  <customLanguageFileList>
    <language code="en" encoding="iso8859-1" file="i18n/en.lng"/>
  </customLanguageFileList>

  <!-- Prebuild Actions -->
  <preBuildActionList>
    <setInstallerVariable name="originalplatform" value="${platform_name}"/>
    <setInstallerVariable name="originalplatform" value="linux-x32">
      <ruleList>
        <compareText text="${platform_name}" value="linux"/>
      </ruleList>
    </setInstallerVariable>
  </preBuildActionList>
  
  <!-- Initialisation actions -->
  <initializationActionList>
    <setInstallerVariable name="productVersion" persist="1" value="PG_VERSION_PGAGENT"/>
    
    <!-- Abort Installation as trying to  run a 32-bit installer on 64-bit machine -->
    <throwError>
      <customErrorMessage>${msg(platform.not.match)}</customErrorMessage>
      <text>Unknown Error</text>
      <ruleList>
        <platformTest type="linux-x64"/>
        <compareText text="${originalplatform}" value="linux-x32"/>
      </ruleList>
    </throwError>
    
    <!-- Set the default values -->
    <setInstallerVariable name="defaultpghost" value="localhost"/>
    <setInstallerVariable name="defaultpguser" value="postgres"/>
    <setInstallerVariable name="defaultpgport" value="5432"/>
    <setInstallerVariable name="defaultpgdbname" value="postgres"/>

    <setInstallerVariableFromRegEx>
      <name>pgagent_installer_schema_version</name>
      <text>${productVersion}</text>
      <pattern>^([0-9]*).(.*)$</pattern>
      <substitution>\1</substitution>
    </setInstallerVariableFromRegEx>

    <!-- Set the default postgres password, to be used only in unnattended mode -->
    <setInstallerVariable name="defaultpgpassword" value=""/>
    <setInstallerVariable name="defaultpgpassword" value="postgres">
      <ruleList>
        <compareText logic="equals" text="${installer_ui}" value="unattended"/>
      </ruleList>
    </setInstallerVariable>

    <!-- Set the default system password, to be used only in unnattended mode -->
    <setInstallerVariable name="defaultsyspassword" value=""/>
    <setInstallerVariable name="defaultsyspassword" value="postgres">
      <ruleList>
        <compareText logic="equals" text="${installer_ui}" value="unattended"/>
      </ruleList>
    </setInstallerVariable>

    <!-- Set the system user, to be used only in unnattended mode -->
    <setInstallerVariable name="systemuser" value=""/>
    <setInstallerVariable name="systemuser" value="postgres">
      <ruleList>
        <compareText logic="equals" text="${installer_ui}" value="unattended"/>
      </ruleList>
    </setInstallerVariable>

    <!-- Set the installation directory for different platform -->
    <setInstallerVariable name="defaultinstalldir" value="${platform_install_prefix}\pgAgent">
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/>
      </ruleList>
    </setInstallerVariable>
    <setInstallerVariable name="defaultinstalldir" value="${platform_install_prefix}/pgAgent">
      <ruleList>
        <compareText logic="contains" text="${platform_name}" value="linux"/>
      </ruleList>
    </setInstallerVariable>
    <setInstallerVariable name="defaultinstalldir" value="/Library/pgAgent">
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="osx"/>
      </ruleList>
    </setInstallerVariable>
    <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{7299052b-02a4-4627-81f2-1818da5d550d}" name="DisplayVersion" variable="VC_REDIST_2005_VERSION"/>
    <actionGroup>
      <actionList>
        <unpackFile>
          <component>configuration</component>
          <destination>${system_temp_directory}\vcredist_x86.exe</destination>
          <folder>vcredistwindows</folder>
          <origin>vcredist_x86.exe</origin>
        </unpackFile>
        <runProgram>
          <program>${system_temp_directory}\vcredist_x86.exe</program>
          <programArguments>/q</programArguments>
          <workingDirectory>${windir}</workingDirectory>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
        </runProgram> 
      </actionList>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/>
        <compareText logic="equals" text="${VC_REDIST_2005_VERSION}" value=""/>
      </ruleList>
    </actionGroup>
  </initializationActionList>
  
  <!-- Preinstallation actions -->
  <preInstallationActionList>

    <!-- Creates the ini file if not exits -->
    <touchFile path="/etc/postgres-reg.ini">
      <ruleList>
        <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
      </ruleList>
    </touchFile>
    <setInstallerVariable name="defaultinstalldir" value="${installdir}"/>
    
    <!-- LIN & MAC : Check Previous Installation of pgAgent -->
    <actionGroup>
      <actionList>
        <iniFileGet file="/etc/postgres-reg.ini" section="pgAgent" key="Version" variable="pgAgentVersion"/>
      </actionList>
      <ruleList>
        <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
      </ruleList>
    </actionGroup>
    
    <!-- LIN & MAC : Set the installation directory in case of re-install/upgrade -->
    <actionGroup>
      <actionList>
        <iniFileGet file="/etc/postgres-reg.ini" section="pgAgent" key="InstallationDirectory" variable="installdir"/>
        <iniFileGet file="/etc/postgres-reg.ini" section="pgAgent" key="ServiceManager" variable="systemuser"/>
        <iniFileGet file="/etc/postgres-reg.ini" section="pgAgent" key="PGUSER" variable="pguser"/>
        <iniFileGet file="/etc/postgres-reg.ini" section="pgAgent" key="PGPORT" variable="pgport"/>
        <iniFileGet file="/etc/postgres-reg.ini" section="pgAgent" key="PGHOST" variable="pghost"/>
        <iniFileGet file="/etc/postgres-reg.ini" section="pgAgent" key="PGDATABASE" variable="pgdbname"/>
      </actionList>
      <ruleList>
        <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/>
        <compareText logic="does_not_equal" text="${platform_name}" value="windows"/> 
      </ruleList>
    </actionGroup>
    
    <!-- WIN : Check Previous Installation of pgAgent -->
    <actionGroup>
      <actionList>
        <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="Version" variable="pgAgentVersion"/>
      </actionList>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/> 
      </ruleList>
    </actionGroup>
    
    <!-- WIN : Set the installation directory in case of re-install/upgrade -->
    <actionGroup>
      <actionList>
        <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="Location" variable="installdir"/>
        <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="ServiceManager" variable="systemuser"/>
        <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="PGUSER" variable="pguser"/>
        <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="PGHOST" variable="pghost"/>
        <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="PGPORT" variable="pgport"/>
      </actionList>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/> 
        <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/> 
      </ruleList>
    </actionGroup>
    
    <!-- LIN : Stop the pgAgent Service -->
    <runProgram>
      <program>/etc/init.d/pgagent</program>
      <programArguments>stop</programArguments>
      <abortOnError>0</abortOnError>
      <showMessageOnError>0</showMessageOnError>
      <ruleList>
        <compareText logic="contains" text="${platform_name}" value="linux"/>
        <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </runProgram>
    
    <!-- WIN : Stop the pgAgent Service -->
    <stopWindowsService>
      <serviceName>pgagent</serviceName>
      <abortOnError>0</abortOnError>
      <showMessageOnError>0</showMessageOnError>
      <customErrorMessage>${msg(error.stop.pgagent)}</customErrorMessage>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/> 
        <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/> 
      </ruleList>
    </stopWindowsService>
    
    <!-- MAC: Stop the pgAgent Service -->
    <runProgram>
      <program>${installdir}/installer/pgAgent/pgagentctl.sh</program>
      <programArguments>stop</programArguments>
      <abortOnError>0</abortOnError>
      <showMessageOnError>0</showMessageOnError>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="osx"/> 
        <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/> 
      </ruleList>
    </runProgram>
  </preInstallationActionList>
  
  <!-- Postinstallation actions -->
  <postInstallationActionList>

    <!-- LIN & MAC : Write the pgAgent Info to INI File -->
    <actionGroup>
      <actionList>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="Description" value="${msg(install.summary)}"/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="InstallationDirectory" value="${installdir}"/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="Version" value="${product_version}"/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="ServiceManager" value="${systemuser}"/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGUSER" value="${pguser}"/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGHOST" value="${pghost}"/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGPORT" value="${pgport}"/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGDATABASE" value="${pgdbname}"/>
      </actionList>
      <ruleList>
        <compareText text="${platform_name}" logic="does_not_equal" value="windows"/>
      </ruleList>
    </actionGroup>

    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="Description" value="${msg(install.summary)}"/>
    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="Location" value="${installdir}"/>
    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="Version" value="${product_version}"/>
    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="ServiceManager" value="${systemuser}"/>
    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="PGUSER" value="${pguser}"/>
    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="PGHOST" value="${pghost}"/>
    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="PGPORT" value="${pgport}"/>
    <registrySet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\pgAgent" name="PGDATABASE" value="${pgdbname}"/>

    <!-- Create the user account with which pgAgent will run-->
    <runProgram>
      <program>${installdir}/installer/pgAgent/createuser.sh</program>
      <programArguments>"${systemuser}" "${installdir}"</programArguments>
      <progressText>${msg(progress.text.creating.user)}</progressText>
      <abortOnError>0</abortOnError>
      <showMessageOnError>0</showMessageOnError>
      <ruleList>
        <compareText text="${platform_name}" logic="does_not_equal" value="windows"/>
        <compareText text="${pgAgentVersion}" logic="equals" value=""/>
      </ruleList>
    </runProgram>

    <!-- WIN : Create user, if not exists -->
    <runProgram>
      <program>${installdir}\installer\pgAgent\createuser.exe</program>
      <!-- The dot at the beginning of the arguments is the domain -->
      <programArguments>. "${systemuser}" "${systempassword}"</programArguments>
      <progressText>${msg(progress.text.creating.user)}</progressText>
      <abortOnError>0</abortOnError>
      <showMessageOnError>0</showMessageOnError>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </runProgram>

    <throwError>
      <text>${msg(script.command.line.error)}</text>
      <ruleList>
        <compareText logic="equals" text="127" value="${program_exit_code}"/>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </throwError>
    <throwError>
      <text>${msg(error.could.not.create.user)}</text>
      <ruleList>
        <compareText logic="equals" text="1" value="${program_exit_code}"/>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </throwError>

    <!-- Create pgagent schema if not exists -->
    <actionGroup>
      <actionList>
        <setEnvironmentVariable name="PGHOST" value="${pghost}"/>
        <setEnvironmentVariable name="PGUSER" value="${pguser}"/>
        <setEnvironmentVariable name="PGPASSWORD" value="${pgpassword}"/>
        <setEnvironmentVariable name="PGPORT" value="${pgport}"/>
        <setEnvironmentVariable name="LD_LIBRARY_PATH" value="${installdir}/lib"/>
        <!-- Create plpgsql, if not exists -->
        <runProgram>
          <program>${installdir}/bin/psql</program>
          <programArguments>-t -c "CREATE LANGUAGE plpgsql"</programArguments>
          <progressText>${msg(progress.text.creating.plpgsql)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
            <compareText logic="equals" text="${plpgsql_exist}" value=""/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>

        <runProgram>
          <program>${installdir}\installer\pgAgent\configurePgAgent.bat</program>
          <programArguments>"CREATE_PLPGSQL" "${installdir}\bin\psql.exe"</programArguments>
          <progressText>${msg(progress.text.creating.plpgsql)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="equals" text="${plpgsql_exist}" value=""/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>

        <!-- Create pgagent schema -->
        <runProgram>
          <program>${installdir}/bin/psql</program>
          <programArguments>-t -f "${installdir}/share/pgagent.sql"</programArguments>
          <progressText>${msg(progress.text.creating.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="equals" text="${pgagent_schema_exist}" value=""/>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>
        <runProgram>
          <program>${installdir}\installer\pgAgent\configurePgAgent.bat</program>
          <programArguments>"CREATE_PGAGENT_SCHEMA" "${installdir}\bin\psql.exe" "${installdir}\share\pgagent.sql"</programArguments>
          <progressText>${msg(progress.text.creating.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="equals" text="${pgagent_schema_exist}" value=""/>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>

        <!-- Inform user about configuring pgagent Schema -->
        <showInfo text="${msg(configure.pgagent.schema)}">
          <ruleList>
            <compareText logic="equals" text="${pgagent_schema_exist}" value=""/>
          </ruleList>
        </showInfo>

        <!-- Upgrade schema pgagent -->
        <runProgram>
          <program>${installdir}/bin/psql</program>
          <programArguments>-t -f "${installdir}/share/pgagent_upgrade.sql"</programArguments>
          <progressText>${msg(progress.text.upgrading.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
            <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
            <compareText logic="equals" text="${upgrade_schema}" value="yes"/>
            <compareText logic="does_not_equal" text="${pgagent_installer_schema_version}" value="${pgagent_current_schema_version}"/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>
        <runProgram>
          <program>${installdir}\installer\pgAgent\configurePgAgent.bat</program>
          <programArguments>"UPGRADE_PGAGENT_SCHEMA" "${installdir}\bin\psql.exe" "${installdir}\share\pgagent_upgrade.sql"</programArguments>
          <progressText>${msg(progress.text.upgrading.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
            <compareText logic="equals" text="${upgrade_schema}" value="yes"/>
            <compareText logic="does_not_equal" text="${pgagent_installer_schema_version}" value="${pgagent_current_schema_version}"/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>

        <!-- Inform user about configuring pgagent schema manually -->
        <showInfo text="${msg(info.pgagent.schema.manual.upgrade)}">
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
            <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
            <compareText logic="does_not_equal" text="${upgrade_schema}" value="yes"/>
            <compareText logic="does_not_equal" text="${pgagent_installer_schema_version}" value="${pgagent_current_schema_version}"/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </showInfo>
        <showInfo text="${msg(info.pgagent.schema.manual.upgrade.windows)}">
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
            <compareText logic="does_not_equal" text="${upgrade_schema}" value="yes"/>
            <compareText logic="does_not_equal" text="${pgagent_installer_schema_version}" value="${pgagent_current_schema_version}"/>
            <compareText logic="does_not_equal" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </showInfo>

      </actionList>
    </actionGroup>

    <!-- Create pgagent schema in unattended mode -->
    <actionGroup>
      <actionList>
        <setEnvironmentVariable name="PGHOST" value="${pghost}"/>
        <setEnvironmentVariable name="PGUSER" value="${pguser}"/>
        <setEnvironmentVariable name="PGPASSWORD" value="${pgpassword}"/>
        <setEnvironmentVariable name="PGPORT" value="${pgport}"/>
        <setEnvironmentVariable name="LD_LIBRARY_PATH" value="${installdir}/lib"/>
        <!-- Create plpgsql, if not exists -->
        <runProgram>
          <program>${installdir}/bin/psql</program>
          <programArguments>-t -c "CREATE LANGUAGE plpgsql"</programArguments>
          <progressText>${msg(progress.text.creating.plpgsql)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
            <compareText logic="equals" text="${schema_in_unattended}" value="install"/>
            <compareText logic="equals" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>

        <runProgram>
          <program>${installdir}\installer\pgAgent\configurePgAgent.bat</program>
          <programArguments>"CREATE_PLPGSQL" "${installdir}\bin\psql.exe"</programArguments>
          <progressText>${msg(progress.text.creating.plpgsql)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="equals" text="${schema_in_unattended}" value="install"/>
            <compareText logic="equals" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>

        <!-- Create pgagent schema -->
        <runProgram>
          <program>${installdir}/bin/psql</program>
          <programArguments>-t -f "${installdir}/share/pgagent.sql"</programArguments>
          <progressText>${msg(progress.text.creating.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="equals" text="${installer_ui}" value="unattended"/>
            <compareText logic="equals" text="${schema_in_unattended}" value="install"/>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
          </ruleList>
        </runProgram>
        <runProgram>
          <program>${installdir}\installer\pgAgent\configurePgAgent.bat</program>
          <programArguments>"CREATE_PGAGENT_SCHEMA" "${installdir}\bin\psql.exe" "${installdir}\share\pgagent.sql"</programArguments>
          <progressText>${msg(progress.text.creating.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="equals" text="${installer_ui}" value="unattended"/>
            <compareText logic="equals" text="${schema_in_unattended}" value="install"/>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
        </runProgram>

        <!-- Upgrade schema pgagent -->
        <runProgram>
          <program>${installdir}/bin/psql</program>
          <programArguments>-t -f "${installdir}/share/pgagent_upgrade.sql"</programArguments>
          <progressText>${msg(progress.text.upgrading.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
            <compareText logic="equals" text="${schema_in_unattended}" value="upgrade"/>
            <compareText logic="equals" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>
        <runProgram>
          <program>${installdir}\installer\pgAgent\configurePgAgent.bat</program>
          <programArguments>"UPGRADE_PGAGENT_SCHEMA" "${installdir}\bin\psql.exe" "${installdir}\share\pgagent_upgrade.sql"</programArguments>
          <progressText>${msg(progress.text.upgrading.pgagentschema)}</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <workingDirectory>${installdir}/bin</workingDirectory>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="equals" text="${schema_in_unattended}" value="upgrade"/>
            <compareText logic="equals" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </runProgram>
      </actionList>
    </actionGroup>
    <substitute>
      <files>${installdir}/installer/pgAgent/pgagentctl.sh</files>
      <substitutionList>
        <substitution pattern="INSTALL_DIR" value="${installdir}"/>
        <substitution pattern="PG_HOST" value="${pghost}"/>
        <substitution pattern="PG_PORT" value="${pgport}"/>
        <substitution pattern="PG_USER" value="${pguser}"/>
        <substitution pattern="SYSTEM_USER" value="${systemuser}"/>
        <substitution pattern="PG_DATABASE" value="${pgdbname}"/>
      </substitutionList>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="osx"/>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </substitute>
    <substitute>
      <files>${installdir}/installer/pgAgent/pgpass</files>
      <substitutionList>
        <substitution pattern="INSTALL_DIR" value="${installdir}"/>
        <substitution pattern="PG_HOST" value="${pghost}"/>
        <substitution pattern="PG_PORT" value="${pgport}"/>
        <substitution pattern="PG_USER" value="${pguser}"/>
        <substitution pattern="PG_PASSWORD" value="${pgpassword}"/>
        <substitution pattern="PG_DATABASE" value="${pgdbname}"/>
      </substitutionList>
      <ruleList>
        <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </substitute>

    <!-- WIN :                                                                   -->
    <!--     1. Create/Append pgpass.conf file in systemuser's appdata directory -->
    <!--     2. Create/Reinstall the pgAgent service                             -->
    <actionGroup>
      <actionList>
        <unpackFile>
          <component>configuration</component>
          <destination>${system_temp_directory}\${product_fullname}\bin\CreatePGPassconfForUser.exe</destination>
          <folder>createpgpassconfforuser</folder>
          <origin>CreatePGPassconfForUser.exe</origin>
        </unpackFile>
        <runProgram>
          <customErrorMessage>${msg(error.create.pgpass)}</customErrorMessage>
          <program>${installdir}\installer\pgAgent\configurePgAgent.bat</program>
          <programArguments>CREATE_PGPASS_CONF "${system_temp_directory}\${product_fullname}\bin\CreatePGPassconfForUser.exe" ${systemuser} ${systempassword} ${pghost} ${pgport} ${pgdbname} ${pguser} ${pgpassword}</programArguments>
          <workingDirectory>${windir}</workingDirectory>
          <abortOnError>0</abortOnError>
          <showMessageOnError>1</showMessageOnError>
        </runProgram>
        <deleteFile>
          <path>${system_temp_directory}\${product_fullname}\bin\CreatePGPassconfForUser.exe</path>
        </deleteFile>

        <!-- WIN : Install pgAgent as Service -->
        <!-- WIN : Remove the existing service, if any exist, when upgrading/reinstalling -->
        <runProgram>
          <program>${installdir}\bin\pgagent.exe</program>
          <programArguments>REMOVE pgAgent</programArguments>
          <workingDirectory>${installdir}\bin</workingDirectory>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <ruleList>
            <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/>
          </ruleList>
        </runProgram>
        <runProgram>
          <customErrorMessage>${msg(error.install.pgagent)}</customErrorMessage>
          <program>${installdir}\bin\pgagent.exe</program>
          <programArguments>INSTALL pgAgent -u ${systemuser} -p ${systempassword} host=${pghost} port=${pgport} user=${pguser} dbname=${pgdbname}</programArguments>
          <workingDirectory>${installdir}\bin</workingDirectory>
          <abortOnError>0</abortOnError>
          <showMessageOnError>1</showMessageOnError>
        </runProgram>
      </actionList>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/>
      </ruleList>
    </actionGroup>
    
    <!-- LIN & MAC : Install pgAgent as Service -->
    <actionGroup>
      <actionList>
        <runProgram>
          <customErrorMessage>${msg(error.install.pgagent)}</customErrorMessage>
          <program>${installdir}/installer/pgAgent/startupcfg.sh</program>
          <programArguments>"${pghost}" "${pgport}" "${pguser}" "${systemuser}" "${installdir}" "${pgdbname}"</programArguments>
          <workingDirectory>${installdir}/installer/pgAgent</workingDirectory>
          <progressText>Configure pgAgent service</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
        </runProgram>
      </actionList>
      <ruleList>
        <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </actionGroup>
    
    <!-- WIN : Start the pgAgent service -->
    <startWindowsService>
      <serviceName>pgAgent</serviceName>
      <abortOnError>0</abortOnError>
      <showMessageOnError>0</showMessageOnError>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/>
      </ruleList>
    </startWindowsService>

    <!-- LIN & MAC : Start pgAgent -->
    <actionGroup>
      <actionList>
        <runProgram>
          <customErrorMessage>${msg(error.install.pgagent)}</customErrorMessage>
          <program>/etc/init.d/pgagent</program>
          <programArguments>start &amp;</programArguments>
          <workingDirectory>/etc/init.d</workingDirectory>
          <progressText>Starting pgAgent service</progressText>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
        </runProgram>
      </actionList>
      <ruleList>
        <compareText logic="contains" text="${platform_name}" value="linux"/>
      </ruleList>
    </actionGroup>

    <!-- MAC : Start the pgAgent service -->
    <runProgram>
      <program>${installdir}/installer/pgAgent/pgagentctl.sh</program>
      <programArguments>start &amp;</programArguments>
      <abortOnError>0</abortOnError>
      <showMessageOnError>0</showMessageOnError>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="osx"/>
      </ruleList>
    </runProgram>

    <!-- Delete the temporary pgpass File -->
    <deleteFile>
      <path>${installdir}/installer/pgAgent/pgpass</path>
    </deleteFile>
  </postInstallationActionList>

  <!-- preUninstallation actions -->
  <preUninstallationActionList>
  
    <!-- LIN & MAC : Unset the pgAgent Info from the ini file -->
    <actionGroup>
      <actionList>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="Description" value=""/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="InstallationDirectory" value=""/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="Version" value=""/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGUSER" value=""/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGHOST" value=""/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGPORT" value=""/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="PGDATABASE" value=""/>
        <iniFileSet file="/etc/postgres-reg.ini" section="pgAgent" key="ServiceManager" value=""/>
      </actionList>
      <ruleList>
        <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
      </ruleList>
    </actionGroup>

    <!-- WIN : Stop and Uninstall pgAgent Service -->
    <actionGroup>
      <actionList>
        <stopWindowsService>
          <serviceName>pgAgent</serviceName>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
          <customErrorMessage>${msg(error.stop.pgagent)}</customErrorMessage>
        </stopWindowsService>
        <runProgram>
          <customErrorMessage>${msg(error.uninstall.pgagent)}</customErrorMessage>
          <program>${installdir}\bin\pgagent.exe</program>
          <programArguments>REMOVE pgagent</programArguments>
          <workingDirectory>${installdir}\bin</workingDirectory>
          <abortOnError>0</abortOnError>
          <showMessageOnError>1</showMessageOnError>
        </runProgram>
      </actionList>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="windows"/>
      </ruleList>
    </actionGroup>

    <!-- MAC : Stop and Uninstall pgAgent Service -->
    <actionGroup>
      <actionList>

        <!-- MAC: Stop the pgAgent Service -->
        <runProgram>
          <customErrorMessage>${msg(error.uninstall.pgagent)}</customErrorMessage>
          <program>${installdir}/installer/pgAgent/pgagentctl.sh</program>
          <programArguments>stop</programArguments>
          <abortOnError>0</abortOnError>
          <showMessageOnError>1</showMessageOnError>
        </runProgram>
        <deleteFile>
          <path>/Library/LaunchDaemons/com.edb.launchd.pgagent.plist</path>
        </deleteFile>
      </actionList>
      <ruleList>
        <compareText logic="equals" text="${platform_name}" value="osx"/>
      </ruleList>
    </actionGroup>

    <!-- LIN : Stop and Uninstall pgAgent Service -->
    <actionGroup>
      <actionList>
  
        <!-- Stop the pgAgent service -->
        <runProgram>
          <program>/etc/init.d/pgagent</program>
          <programArguments>stop</programArguments>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
        </runProgram>

        <!-- Attempt to remove any runlevel config with chkconfig -->
        <runProgram>
          <customErrorMessage>${msg(error.uninstall.pgagent)}</customErrorMessage>
          <program>/sbin/chkconfig</program>
          <programArguments>--del pgagent</programArguments>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
        </runProgram>

        <!-- Remove the startup script -->
        <deleteFile>
          <path>/etc/init.d/pgagent</path>
        </deleteFile>

        <!-- Attempt to remove any runlevel config with update-rc.d -->
        <runProgram>
          <customErrorMessage>${msg(error.uninstall.pgagent)}</customErrorMessage>
          <program>/usr/sbin/update-rc.d</program>
          <programArguments>-f pgagent remove</programArguments>
          <abortOnError>0</abortOnError>
          <showMessageOnError>0</showMessageOnError>
        </runProgram>
      </actionList>
      <ruleList>
        <compareText logic="contains" text="${platform_name}" value="linux"/>
      </ruleList>
    </actionGroup>
  </preUninstallationActionList>

  <!-- postUninstallation actions -->
  <postUninstallationActionList>
  
    <!-- Prompt user about pgAgent Schema Deletion/Drop -->
    <showInfo>
      <text>${msg(schema.drop.info)}</text>
    </showInfo>
  </postUninstallationActionList>

  <!-- Components -->
  <componentList>
    <component>
      <name>pgAgent</name>
      <description>pgAgent components</description>
      <canBeEdited>0</canBeEdited>
      <selected>1</selected>
      <show>1</show>
      <folderList>
  
        <!-- LIN : Program files -->
        <folder>
          <description>Program Files</description>
          <destination>${installdir}</destination>
          <name>programfileslinux</name>
          <platforms>linux</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/linux/bin</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Library Files</description>
          <destination>${installdir}</destination>
          <name>libfileslinux</name>
          <platforms>linux</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/linux/lib</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Configure Files</description>
          <destination>${installdir}</destination>
          <name>configurefileslinux</name>
          <platforms>linux</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/linux/share</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Installer Files</description>
          <destination>${installdir}</destination>
          <name>installfileslinux</name>
          <platforms>linux</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/linux/installer</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Other Files</description>
          <destination>${installdir}</destination>
          <name>otherfileslinux</name>
          <platforms>linux</platforms>
          <distributionFileList>
            <distributionFile>
              <origin>staging/linux/LICENSE</origin>
            </distributionFile>
            <distributionFile>
              <origin>staging/linux/README</origin>
            </distributionFile>
          </distributionFileList>
        </folder>

        <!-- LIN-X64 : Program files -->
        <folder>
          <description>Program Files</description>
          <destination>${installdir}</destination>
          <name>programfileslinux-x64</name>
          <platforms>linux-x64</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/linux-x64/bin</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Library Files</description>
          <destination>${installdir}</destination>
          <name>libfileslinux-x64</name>
          <platforms>linux-x64</platforms>
          <distributionFileList>
            <distributionDirectory>
                <origin>staging/linux-x64/lib</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Configure Files</description>
          <destination>${installdir}</destination>
          <name>configurefileslinux-x64</name>
          <platforms>linux-x64</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/linux-x64/share</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Installer Files</description>
          <destination>${installdir}</destination>
          <name>installfileslinux-x64</name>
          <platforms>linux-x64</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/linux-x64/installer</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Other Files</description>
          <destination>${installdir}</destination>
          <name>otherfileslinux-x64</name>
          <platforms>linux-x64</platforms>
          <distributionFileList>
            <distributionFile>
              <origin>staging/linux-x64/LICENSE</origin>
            </distributionFile>
	    <distributionFile>
              <origin>staging/linux-x64/README</origin>
            </distributionFile>
          </distributionFileList>
        </folder>

        <!-- WIN : Program files -->
        <folder>
          <description>Program Files</description>
          <destination>${installdir}/bin</destination>
          <name>pgagentbinarywindows</name>
          <platforms>windows</platforms>
          <distributionFileList>
            <distributionFile>
              <origin>staging/windows/pgagent.exe</origin>
            </distributionFile>
            <distributionFile>
              <origin>staging/windows/pgaevent.dll</origin>
            </distributionFile>
          </distributionFileList>
       </folder>
       <folder>
          <description>Supported Library Files</description>
          <destination>${installdir}</destination>
          <name>libfileswindows</name>
          <platforms>windows</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/windows/bin</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Configure Files</description>
          <destination>${installdir}/share</destination>
          <name>configurefileswindows</name>
          <platforms>windows</platforms>
          <distributionFileList>
            <distributionFile>
              <origin>staging/windows/pgagent.sql</origin>
            </distributionFile>
            <distributionFile>
              <origin>staging/windows/pgagent_upgrade.sql</origin>
            </distributionFile>
          </distributionFileList>
        </folder>
        <folder>
          <description>Installer Files</description>
          <destination>${installdir}</destination>
          <name>installfileswindows</name>
          <platforms>windows</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/windows/installer</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Other Files</description>
          <destination>${installdir}</destination>
          <name>otherfileswindows</name>
          <platforms>windows</platforms>
          <distributionFileList>
            <distributionFile>
              <origin>staging/windows/LICENSE</origin>
            </distributionFile>
            <distributionFile>
              <origin>staging/windows/README</origin>
            </distributionFile>
          </distributionFileList>
        </folder>

        <!-- MAC : Program files -->
        <folder>
          <description>Program Files</description>
          <destination>${installdir}</destination>
          <name>programfilesosx</name>
          <platforms>osx</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/osx/bin</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Library Files</description>
          <destination>${installdir}</destination>
          <name>libfilesosx</name>
          <platforms>osx</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/osx/lib</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Configure Files</description>
          <destination>${installdir}</destination>
          <name>configurefilesosx</name>
          <platforms>osx</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/osx/share</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Installer Files</description>
          <destination>${installdir}</destination>
          <name>installfilesosx</name>
          <platforms>osx</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/osx/installer</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
        <folder>
          <description>Other Files</description>
          <destination>${installdir}</destination>
          <name>otherfilesosx</name>
          <platforms>osx</platforms>
          <distributionFileList>
            <distributionFile>
              <origin>staging/osx/LICENSE</origin>
            </distributionFile>
            <distributionFile>
              <origin>staging/osx/README</origin>
            </distributionFile>
          </distributionFileList>
        </folder>
      </folderList>
    </component>
    <component>
      <name>configuration</name>
      <description>Configure</description>
      <canBeEdited>0</canBeEdited>
      <selected>0</selected>
      <show>0</show>
      <folderList>
        <!-- WIN : CreatePGPassconfForUser executable -->
        <folder>
          <description>CreatePGPassconfForUser</description>
          <destination>${installdir}\bin</destination>
          <name>createpgpassconfforuser</name>
          <platforms>windows</platforms>
          <distributionFileList>
            <distributionFile>
              <origin>staging/windows/CreatePGPassconfForUser.exe</origin>
            </distributionFile>
          </distributionFileList>
        </folder>
        <folder>
          <description>Visual C++.Net 2005 Redistribution Files</description>
          <destination>${installdir}</destination>
          <name>vcredistwindows</name>
          <platforms>windows</platforms>
          <distributionFileList>
            <distributionDirectory>
              <origin>staging/windows/vcredist_x86.exe</origin>
            </distributionDirectory>
          </distributionFileList>
        </folder>
      </folderList>
    </component>
  </componentList>

  <!-- PostgreSQL Details Verification Page -->
  <parameterList>
    <stringParameter name="originalplatform" ask="0" cliOptionShow="0"/>

    <!-- Install Directory -->
    <directoryParameter>
      <name>installdir</name>
      <description>Installer.Parameter.installdir.description</description>
      <explanation>${msg(pgagent.installdir.explanation)}</explanation>
      <value>${defaultinstalldir}</value>
      <default/>
      <allowEmptyValue>0</allowEmptyValue>
      <ask>yes</ask>
      <cliOptionName>prefix</cliOptionName>
      <mustBeWritable>yes</mustBeWritable>
      <mustExist>0</mustExist>
      <width>40</width>
      <ruleList>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
      </ruleList>

      <!-- Validating whether installdir is empty -->
      <validationActionList>
        <actionGroup>
          <actionList>
            <setInstallerVariable name="installdir" value="${defaultinstalldir}"/>
            <throwError>
              <text>${msg(pgagent.installdir.empty)}</text>
            </throwError>
          </actionList>
          <ruleList>
            <compareText logic="equals" text="${installdir}" value=""/>
          </ruleList>
        </actionGroup>
      </validationActionList>

      <!-- Validating whether installdir is valid -->
      <validationActionList>
  
        <!-- Validating whether installdir contains whitespaces (Linux) -->
        <actionGroup>
          <actionList>
            <setInstallerVariable name="installdir" value="${defaultinstalldir}"/>
            <throwError>
              <text>${msg(pgagent.installdir.error)}</text>
            </throwError>
            <setInstallerVariable name="next_page" value="installdir"/>
          </actionList>
          <ruleList>
            <regExMatch text="${installdir}" logic="does_not_match" pattern="^/([0-9a-zA-Z_/\.\-]*)$"/>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
          </ruleList>
        </actionGroup>

        <!-- Validating whether installdir is valid (Windows) -->
        <actionGroup>
          <actionList>
            <setInstallerVariable name="installdir" value="${defaultinstalldir}"/>
            <throwError>
              <text>${msg(pgagent.installdir.error)}</text>
            </throwError>
            <setInstallerVariable name="next_page" value="installdir"/>
          </actionList>
          <ruleList>
            <regExMatch text="${installdir}" logic="does_not_match" pattern="^([a-zA-Z]:)\\([0-9a-zA-Z_\\\s\.\-\(\)]*)$"/>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
        </actionGroup>
      </validationActionList>
    </directoryParameter>

    <!-- Explain that we're using an existing installation directory -->
    <labelParameter>
      <name>upgrade</name>
      <title>${msg(upgrade.existing.installation.title)}</title>
      <description>${msg(upgrade.existing.installation.description)}</description>
      <ruleList>
        <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/>
      </ruleList>
    </labelParameter>
    <parameterGroup>
      <name>pgdetails</name>
      <title>${msg(pg.details.title)}</title>
      <explanation>${msg(pg.details.explanation)}</explanation>
      <value/>
      <default/>
      <parameterList>

        <!-- Postgres Host -->
        <stringParameter>
          <name>pghost</name>
          <description>Host</description>
          <explanation/>
          <value/>
          <default>${defaultpghost}</default>
          <allowEmptyValue>1</allowEmptyValue>
          <width>40</width>
        </stringParameter>
  
        <!-- Postgres User -->
        <stringParameter>
          <name>pguser</name>
          <description>User Name</description>
          <explanation/>
          <value/>
          <default>${defaultpguser}</default>
          <allowEmptyValue>1</allowEmptyValue>
          <width>40</width>
        </stringParameter>

        <!-- Postgres User Password -->
        <passwordParameter>
          <name>pgpassword</name>
          <title>Password</title>
          <description>Password</description>
          <explanation/>
          <value/>
          <default>${defaultpgpassword}</default>
          <allowEmptyValue>1</allowEmptyValue>
          <askForConfirmation>0</askForConfirmation>
          <descriptionRetype/>
          <width>40</width>
        </passwordParameter>

        <!-- Postgres Port(Default 5432) -->
        <stringParameter>
          <name>pgport</name>
          <description>Port</description>
          <explanation/>
          <value/>
          <default>${defaultpgport}</default>
          <allowEmptyValue>1</allowEmptyValue>
          <width>40</width>
        </stringParameter>

        <stringParameter cliOptionName="dbname" ask="0" cliOptionShow="0">
          <name>pgdbname</name>
          <description>Database</description>
          <explanation/>
          <value/>
          <default>${defaultpgdbname}</default>
          <allowEmptyValue>1</allowEmptyValue>
          <width>40</width>
        </stringParameter>
        
        <choiceParameter cliOptionName="schema" ask="0" cliOptionShow="1">
          <name>schema_in_unattended</name>
          <description/>
          <explanation/>
          <value/>
          <default>install</default>
          <optionList>
            <option value="none"/>
            <option value="exists"/>
            <option value="upgrade"/>
            <option value="install"/>
          </optionList>
        </choiceParameter>

      </parameterList>

      <preShowPageActionList>
        <setInstallerVariable name="pgagent_schema_exist" value="0"/>
        <setInstallerVariable name="pgagent_schema_version_function_exist" value="0"/>
        <setInstallerVariable name="pgagent_current_schema_version" value=""/>
        <setInstallerVariable name="upgrade_schema" value="yes"/>
      </preShowPageActionList>

      <!-- Checking the validity of PostgreSQL Server Details -->
      <validationActionList>
        <actionGroup>
          <actionList>
            <throwError>
              <text>${msg(pg.blank.error)}</text>
            </throwError>
          </actionList>
          <ruleEvaluationLogic>OR</ruleEvaluationLogic>
          <ruleList>
            <compareText logic="equals" text="${pgport}" value=""/>
            <compareText logic="equals" text="${pguser}" value=""/>
            <compareText logic="equals" text="${pgpassword}" value=""/>
            <compareText logic="equals" text="${pgdbname}" value=""/>
          </ruleList>
        </actionGroup>

        <!-- Creating a temporary directory -->
        <createDirectory path="${system_temp_directory}/${product_fullname}"/>

        <!-- Create temporary directory -->
        <createDirectory path="${system_temp_directory}/${product_fullname}/bin"/>

        <!-- Validate the PostgreSQL Server Details -->
        <actionGroup>
          <actionList>

            <!-- LIN: Unpack psql and its shared libraries -->
            <unpackFile>
              <component>pgAgent</component>
              <destination>${system_temp_directory}/${product_fullname}/bin/psql</destination>
              <folder>programfileslinux</folder>
              <origin>bin/psql</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="linux"/>
              </ruleList>
            </unpackFile>
            <unpackDirectory>
              <component>pgAgent</component>
              <destination>${system_temp_directory}/${product_fullname}/lib</destination>
              <folder>libfileslinux</folder>
              <origin>lib</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="linux"/>
              </ruleList>
            </unpackDirectory>
            
            <!-- LIN-x64: Unpack psql and its shared libraries -->
            <unpackFile>
              <component>pgAgent</component>
              <destination>${system_temp_directory}/${product_fullname}/bin/psql</destination>
              <folder>programfileslinux-x64</folder>
              <origin>bin/psql</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="linux-x64"/>
              </ruleList>
            </unpackFile>
            <unpackDirectory>
              <component>pgAgent</component>
              <destination>${system_temp_directory}/${product_fullname}/lib</destination>
              <folder>libfileslinux-x64</folder>
              <origin>lib</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="linux-x64"/>
              </ruleList>
            </unpackDirectory>

            <!-- MAC: Unpack psql and its shared libraries -->
            <unpackFile>
              <component>pgAgent</component>
              <destination>${system_temp_directory}/${product_fullname}/bin/psql</destination>
              <folder>programfilesosx</folder>
              <origin>bin/psql</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="osx"/>
              </ruleList>
            </unpackFile>
            <unpackDirectory>
              <component>pgAgent</component>
              <destination>${system_temp_directory}/${product_fullname}/lib</destination>
              <folder>libfilesosx</folder>
              <origin>lib</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="osx"/>
              </ruleList>
            </unpackDirectory>

            <!-- WIN: Unpack psql and its shared libraries -->
            <unpackFile>
              <component>pgAgent</component>
              <destination>${system_temp_directory}\${product_fullname}\bin\psql.exe</destination>
              <folder>libfileswindows</folder>
              <origin>bin\psql.exe</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
              </ruleList>
            </unpackFile>
            <unpackFile>
              <component>pgAgent</component>
              <destination>${system_temp_directory}\${product_fullname}\bin\checkPG.bat</destination>
              <folder>installfileswindows</folder>
              <origin>installer/pgAgent/configurePgAgent.bat</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
              </ruleList>
            </unpackFile>

            <unpackDirectory>
              <component>pgAgent</component>
              <destination>${system_temp_directory}\${product_fullname}</destination>
              <folder>libfileswindows</folder>
              <origin>bin</origin>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
              </ruleList>
            </unpackDirectory>

            <!-- Running the Script to validate the PostgreSQL Server Details -->
            <setEnvironmentVariable name="PGHOST" value="${pghost}"/>
            <setEnvironmentVariable name="PGUSER" value="${pguser}"/>
            <setEnvironmentVariable name="PGPASSWORD" value="${pgpassword}"/>
            <setEnvironmentVariable name="PGPORT" value="${pgport}"/>
            <setEnvironmentVariable name="PGDATABASE" value="${pgdbname}"/>
            <setEnvironmentVariable name="LD_LIBRARY_PATH" value="${system_temp_directory}/${product_fullname}/lib"/>

            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}/${product_fullname}/bin/psql</exec>
              <execArgs>-l ${pgdbname}</execArgs>
              <name>connection</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}/bin</workingDirectory>
              <customErrorMessage>${msg(pg.details.error)}</customErrorMessage>
              <ruleList>
                <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}\${product_fullname}\bin\checkPG.bat</exec>
              <execArgs>"CHECK_CONNECTION" "${system_temp_directory}\${product_fullname}\bin\psql.exe" "${pgdbname}"</execArgs>
              <name>connection</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}/bin</workingDirectory>
              <customErrorMessage>${msg(pg.details.error)}</customErrorMessage>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <stringModify text="${connection}" variable="connection" logic="trim"/>

            <!-- Check if plpgsql exists -->
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}/${product_fullname}/bin/psql</exec>
              <execArgs>-t -A -c "SELECT lanname FROM pg_language WHERE lanname='plpgsql'"</execArgs>
              <name>plpgsql_exist</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}\${product_fullname}\bin\checkPG.bat</exec>
              <execArgs>"CHECK_PLPGSQL" "${system_temp_directory}\${product_fullname}\bin\psql.exe"</execArgs>
              <name>plpgsql_exist</name>
              <workingDirectory>${system_temp_directory}\${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <stringModify text="${plpgsql_exist}" variable="plpgsql_exist" logic="trim"/>

            <!-- Check for existing pgagent schema -->
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}/${product_fullname}/bin/psql</exec>
              <execArgs>-t -A -c "SELECT has_schema_privilege('pgagent', 'USAGE')"</execArgs>
              <name>pgagent_schema_exist</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}\${product_fullname}\bin\checkPG.bat</exec>
              <execArgs>"CHECK_PGAGENT_SCHEMA" "${system_temp_directory}\${product_fullname}\bin\psql.exe"</execArgs>
              <name>pgagent_schema_exist</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <stringModify text="${pgagent_schema_exist}" variable="pgagent_schema_exist" logic="trim"/>

            <!-- Check for pgagent_schema_version function exist -->
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}/${product_fullname}/bin/psql</exec>
              <execArgs>-t -A -c "SELECT COUNT(*) FROM pg_proc WHERE proname = 'pgagent_schema_version' AND pronamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'pgagent') AND prorettype = (SELECT oid FROM pg_type WHERE typname = 'int2') AND proargtypes = ''"</execArgs>
              <name>pgagent_schema_version_function_exist</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
                <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}\${product_fullname}\bin\checkPG.bat</exec>
              <execArgs>"CHECK_PGAGENT_SCHEMA_VERSION_FUNCTION_EXIST" "${system_temp_directory}\${product_fullname}\bin\psql.exe"</execArgs>
              <name>pgagent_schema_version_function_exist</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
                <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <stringModify text="${pgagent_schema_version_function_exist}" variable="pgagent_schema_version_function_exist" logic="trim"/>

            <!-- Check for the current version of the pgagent schema -->
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}/${product_fullname}/bin/psql</exec>
              <execArgs>-t -A -c "SELECT pgagent.pgagent_schema_version()"</execArgs>
              <name>pgagent_current_schema_version</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
                <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
                <compareText logic="equals" text="${pgagent_schema_version_function_exist}" value="1"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <setInstallerVariableFromScriptOutput>
              <exec>${system_temp_directory}\${product_fullname}\bin\checkPG.bat</exec>
              <execArgs>"CHECK_CURRENT_PGAGENT_SCHEMA_VERSION" "${system_temp_directory}\${product_fullname}\bin\psql.exe"</execArgs>
              <name>pgagent_current_schema_version</name>
              <workingDirectory>${system_temp_directory}/${product_fullname}</workingDirectory>
              <showMessageOnError>0</showMessageOnError>
              <abortOnError>0</abortOnError>
              <ruleList>
                <compareText logic="equals" text="${platform_name}" value="windows"/>
                <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
                <compareText logic="equals" text="${pgagent_schema_version_function_exist}" value="1"/>
              </ruleList>
            </setInstallerVariableFromScriptOutput>
            <stringModify text="${pgagent_current_schema_version}" variable="pgagent_current_schema_version" logic="trim"/>

          </actionList>
        </actionGroup>

        <!-- For pgagent schema already exists -->
        <actionGroup>
          <actionList>

            <!-- 1. pgagent schema exist and pgagent_schema_version function does not exist -->
            <showQuestion text="${msg(pgagent.schema.older.exist)}" variable="upgrade_schema">
              <ruleList>
                <compareText logic="does_not_equal" text="${pgagent_schema_version_function_exist}" value="1"/>
              </ruleList>
            </showQuestion>

            <!-- 2. pgagnet schema exist and pgagent_schema_version function exists,
                    but current_schema_version less than the installer_schema_version -->
            <showQuestion text="${msg(pgagent.schema.older.version.exist)}" variable="upgrade_schema">
              <ruleList>
                <compareText logic="equals" text="${pgagent_schema_version_function_exist}" value="1"/>
                <compareValues logic="less" value1="${pgagent_current_schema_version}" value2="${pgagent_installer_schema_version}"/>
              </ruleList>
            </showQuestion>

            <!-- 3. pgagnet schema exist and pgagent_schema_version function exists,
                    and current_schema_version matches the installer_schema_version -->
            <showInfo text="${msg(pgagent.schema.found)}">
              <ruleList>
                <compareText logic="equals" text="${pgagent_schema_version_function_exist}" value="1"/>
                <compareValues logic="equals" value1="${pgagent_current_schema_version}" value2="${pgagent_installer_schema_version}"/>
              </ruleList>
            </showInfo>

            <!-- 4. pgagnet schema exist and pgagent_schema_version function exists,
                    but current_schema_version greater than the installer_schema_version -->
            <actionGroup>
              <actionList>
                <throwError text="${msg(pgagent.schema.newer.version.exist)}"/>
                <setInstallerVariable name="next_page" value="pgdetails"/>
              </actionList>
              <ruleList>
                <compareText logic="equals" text="${pgagent_schema_version_function_exist}" value="1"/>
                <compareValues logic="greater" value1="${pgagent_current_schema_version}" value2="${pgagent_installer_schema_version}"/>
              </ruleList>
            </actionGroup>

          </actionList>
          <ruleList>
            <compareText logic="does_not_equal" text="${pgagent_schema_exist}" value=""/>
          </ruleList>
        </actionGroup>

        <!-- Set systemuser as postgres -->
        <actionGroup>
          <actionList>
            <setInstallerVariable name="systemuser" value="postgres" persist="1"/>
          </actionList>
          <ruleList>
            <compareText logic="equals" text="${pgAgentVersion}" value=""/>
            <compareText logic="equals" text="${systemuser}" value=""/>
          </ruleList>
        </actionGroup>
      </validationActionList>
    </parameterGroup>
    <parameterGroup>
      <name>sysuserdetails</name>
      <title>${msg(sysuser.details.title)}</title>
      <explanation>${_explanation}</explanation>
      <!-- Do not show this page if reinstallation other than windows -->
      <preShowPageActionList>
        <setInstallerVariable>
          <name>_explanation</name>
          <value>${msg(sysuser.details.explanation)}</value>
        </setInstallerVariable>

        <!-- On Windows, we need a different explanation -->
        <setInstallerVariable>
          <name>_explanation</name>
          <value>${msg(sysuser.details.explanation.windows)}</value>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
        </setInstallerVariable>

        <!-- On Windows, we need a different explanation -->
        <setInstallerVariable>
          <name>_explanation</name>
          <value>${msg(sysuser.details.explanation.withuser.windows)}</value>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="does_not_equal" text="${pgAgentVersion}" value=""/>
          </ruleList>
        </setInstallerVariable>
      </preShowPageActionList>
      <parameterList>
        <stringParameter>
          <name>systemuser</name>
          <description>${msg(config.systemuser.description)}</description>
          <explanation/>
          <value/>
          <default/>
          <allowEmptyValue>1</allowEmptyValue>
          <width>40</width>
          <cliOptionName>systemuser</cliOptionName>
          <cliOptionShow>yes</cliOptionShow>
          <ruleList>
            <compareText logic="equals" text="${pgAgentVersion}" value=""/>
          </ruleList>
        </stringParameter>
        <passwordParameter>
          <name>systempassword</name>
          <description>${msg(config.syspassword.description)}</description>
          <explanation/>
          <value/>
          <default>${defaultsyspassword}</default>
          <allowEmptyValue>1</allowEmptyValue>
          <cliOptionName>systempassword</cliOptionName>
          <cliOptionShow>yes</cliOptionShow>
          <descriptionRetype>${msg(config.syspassword.confirm)}</descriptionRetype>
          <width>40</width>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
        </passwordParameter>
      </parameterList>
      <ruleEvaluationLogic>OR</ruleEvaluationLogic>
      <ruleList>
        <compareText logic="equals" text="${pgAgentVersion}" value=""/>
        <compareText logic="equals" text="${platform_name}" value="windows"/>
      </ruleList>
      <validationActionList>
        <actionGroup>
          <actionList>
            <throwError>
              <text>${msg(systemuser.blank.error)}</text>
            </throwError>
          </actionList>
          <ruleList>
            <compareText logic="equals" text="${systemuser}" value=""/>
          </ruleList>
        </actionGroup>
        <actionGroup>
          <actionList>
            <throwError>
              <text>${msg(systempassword.blank.error)}</text>
            </throwError>
          </actionList>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
            <compareText logic="equals" text="${systempassword}" value=""/>
          </ruleList>
        </actionGroup>
        <!-- WIN : Validate user name & password -->
        <actionGroup>
          <actionList>
            <unpackFile>
              <component>pgAgent</component>
              <destination>${system_temp_directory}\${product_fullname}\bin\validateuser.exe</destination>
              <folder>installfileswindows</folder>
              <origin>installer\pgAgent\validateuser.exe</origin>
            </unpackFile>
            <runProgram>
              <program>${system_temp_directory}\${product_fullname}\bin\validateuser.exe</program>
              <programArguments>. "${systemuser}" "${systempassword}"</programArguments>
              <abortOnError>0</abortOnError>
              <showMessageOnError>0</showMessageOnError>
            </runProgram>
            <throwError>
              <text>${msg(script.command.line.error)}</text>
              <ruleList>
                <compareText logic="equals" text="${program_exit_code}" value="127"/>
              </ruleList>
            </throwError>
            <throwError>
              <text>${msg(config.systempassword.incorrect.windows)}</text>
              <ruleList>
                <compareText logic="equals" text="${program_exit_code}" value="1"/>
              </ruleList>
            </throwError>
          </actionList>
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
      </actionGroup>
      </validationActionList>
      <preShowPageActionList>
     </preShowPageActionList>
   </parameterGroup>
  </parameterList>
</project>
