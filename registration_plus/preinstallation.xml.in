<actionGroup>
  <actionList>
    <setInstallerVariable name="iExistingEmail" persist="0" value=""/>
    <setInstallerVariable name="machine_id" persist="0" value=""/>
    <setInstallerVariable name="installation_id" persist="0" value=""/>

    <iniFileGet file="@@REGISTRY_INI@@" section="Global_machine_id" key="MachineID" variable="machine_id" >
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
          </ruleList>
    </iniFileGet>
    <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\Global_machine_id" name="MachineID" variable="machine_id">
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
    </registryGet>
    <!-- Set the Installation Directory in case of re-install/upgrade -->
    <actionGroup>
      <actionList>
	<iniFileGet file="@@REGISTRY_INI@@" section="@@REGISTRY_PREFIX@@" key="InstallationID" variable="installation_id" >
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
          </ruleList>
	</iniFileGet>
        <iniFileGet file="@@REGISTRY_INI@@" section="@@REGISTRY_PREFIX@@" key="Username" variable="iExistingEmail">
          <ruleList>
            <compareText logic="does_not_equal" text="${platform_name}" value="windows"/>
          </ruleList>
        </iniFileGet>
	<registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\@@REGISTRY_PREFIX@@" name="InstallationID" variable="installation_id">
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
	</registryGet>
        <registryGet key="HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\@@REGISTRY_PREFIX_WIN@@" name="Username" variable="iExistingEmail">
          <ruleList>
            <compareText logic="equals" text="${platform_name}" value="windows"/>
          </ruleList>
        </registryGet>
      </actionList>
      <ruleList>
        <stringTest type="not_empty" text="${@@COMPONENT_VERSION@@}"/>
      </ruleList>
    </actionGroup>

    <!-- Existing install with Username (ignore command-line) -->
    <setInstallerVariable name="existingEmail" persist="0" value="${iExistingEmail}">
      <ruleList>
        <compareText logic="does_not_equal" text="${@@COMPONENT_VERSION@@}" value=""/>
        <compareText logic="does_not_equal" text="${iExistingEmail}" value=""/>
      </ruleList>
    </setInstallerVariable>

    <!-- dummy value for existingEmail, if registration_plus_required set to 0 -->
    <setInstallerVariable name="existingEmail" value="dummy@nonexists.edb.com">
      <ruleList>
        <isFalse value="${registration_plus_required}"/>
        <compareText logic="equals" text="${iExistingEmail}" value=""/>
      </ruleList>
    </setInstallerVariable>

    <throwError text="${msg(registration_plus.emailpassword.not.provided)}" abortOnError="1">
      <ruleList>
        <ruleGroup>
          <ruleEvaluationLogic>or</ruleEvaluationLogic>
          <ruleList>
            <compareText logic="equals" text="${existingEmail}" value=""/>
            <compareText logic="equals" text="${existingPassword}" value=""/>
          </ruleList>
        </ruleGroup>
        <compareText logic="equals" text="${installer_ui}" value="unattended"/>
        <compareText logic="equals" text="${iExistingEmail}" value=""/>
        <isTrue value="${registration_plus_required}"/>
	<isTrue value="${is_internet_connected}" />
      </ruleList>
    </throwError>

    <throwError text="${msg(registration_plus.error.invalid.email.value)}">
      <ruleList>
        <regExMatch logic="does_not_match" text="${existingEmail}">
          <pattern>^([\w]+)(([-\.][\w]+)?)*@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)</pattern>
        </regExMatch>
        <compareText logic="equals" text="${installer_ui}" value="unattended"/>
        <isTrue value="${registration_plus_required}"/>
        <compareText logic="equals" text="${iExistingEmail}" value=""/>
	<isTrue value="${is_internet_connected}" />
      </ruleList>
    </throwError>

    <!-- Get the processor arch and operating system -->
    <actionGroup>
	<actionList>
	    <runProgram>
		<program>uname</program>
		<programArguments>-m</programArguments>
		<showMessageOnError>0</showMessageOnError>
		<abortOnError>0</abortOnError>
		<ruleList>
		    <fileExists path="/etc/debian_version" />
		</ruleList>
	    </runProgram>
    	    <runProgram>
		<program>uname</program>
		<programArguments>-p</programArguments>
		<showMessageOnError>0</showMessageOnError>
		<abortOnError>0</abortOnError>
		<ruleList>
		    <fileTest condition="not_exists" path="/etc/debian_version" />
		</ruleList>
	    </runProgram>
	    <setInstallerVariable name="processor_arch" value="${program_stdout}" />    
	</actionList>
	<ruleList>
	    <compareText text="${platform_name}" logic="does_not_equal" value="windows" />
	</ruleList>
    </actionGroup>
    <setInstallerVariable name="processor_arch" value="${env(PROCESSOR_ARCHITECTURE)}" >
	<ruleList>
	    <compareText text="${platform_name}" logic="equals" value="windows" />
	</ruleList>
    </setInstallerVariable>
    <setInstallerVariable name="os" value="${windows_os_name}" >
	<ruleList>
	    <compareText text="${platform_name}" logic="equals" value="windows" />
	</ruleList>
    </setInstallerVariable>
    <actionGroup>
	<actionList>
	    <runProgram>
		<program>uname</program>
		<programArguments>-r</programArguments>
		<showMessageOnError>0</showMessageOnError>
		<abortOnError>0</abortOnError>
	    </runProgram>
	    <setInstallerVariable name="os" value="Solaris ${program_stdout}" />
	</actionList>
	<ruleList>
	    <compareText text="${platform_name}" logic="contains" value="solaris" />
	</ruleList>
    </actionGroup>
    <setInstallerVariable name="os" value="Linux ${linux_distribution_version}" >
	<ruleList>
	    <compareText text="${platform_name}" logic="contains" value="linux" />
	</ruleList>
    </setInstallerVariable>
    <setInstallerVariable name="os" value="Macintosh ${osx_version}" >
	<ruleList>
	    <compareText text="${platform_name}" logic="equals" value="osx" />
	</ruleList>
    </setInstallerVariable>

    <urlEncode>
        <text>${os}</text>
        <variable>enc_os</variable>
    </urlEncode>
    <urlEncode>
        <text>@@COMPONENT@@</text>
        <variable>enc_component</variable>
    </urlEncode>
    <urlEncode>
	<text>PRODUCT_DESCRIPTION</text>
	<variable>enc_desc</variable>
    </urlEncode>

    <!-- Unpack scripts and required libraries -->
    <unpackDirectory
	    component="userValidation"
	    destination="${system_temp_directory}\registration_plus_${random_number_reg}"
	    folder="registration_plus${platform_name}"
	    origin="UserValidation">
       <ruleList>
	  <compareText logic="equals" text="${platform_name}" value="windows" />
       </ruleList>
    </unpackDirectory>

    <setInstallerVariable name="vcredist_exe" value="vcredist_x86.exe" />	
    <setInstallerVariable name="vcredist_exe" value="vcredist_x64.exe" >
	<ruleList>
	    <platformTest type="windows-x64" />
	    <compareValues logic="equals" value1="@@WINDIR@@" value2="windows-x64" />
	</ruleList>
    </setInstallerVariable>	

    <runProgram program="${system_temp_directory}\registration_plus_${random_number_reg}\UserValidation\${vcredist_exe}"
               programArguments="/q" workingDirectory="${system_temp_directory}\registration_plus_${random_number_reg}\UserValidation"
               abortOnError="0" showMessageOnError="0">
	<ruleList>
	    <compareText text="${platform_name}" logic="equals" value="windows" />
	</ruleList>
    </runProgram>
 
    <actionGroup>
      <actionList>

	<actionGroup>
	    <actionList>
   
		<!-- Generate UUID -->
		<setInstallerVariableFromScriptOutput
		    name="machine_id"
		    showMessageOnError="0"
		    exec="${system_temp_directory}\registration_plus_${random_number_reg}\UserValidation\dbserver_guid.exe"
		    abortOnError="0">
		</setInstallerVariableFromScriptOutput>

		<setInstallerVariableFromRegEx
		    name="machine_id"
		    text="${machine_id}"
		    pattern="^dbser_guid=([A-Fa-f0-9\-]*)$"
		    substitution="\1"
		    abortOnError="0"
		    showMessageOnError="0">
		    <ruleList>
			<compareText logic="does_not_equal" text="${machine_id}" value=""/>
		    </ruleList>
		</setInstallerVariableFromRegEx>
		<setInstallerVariable name="machine_id" value="16a874e6-241e-44ae-b27e-74aecded209a">
		    <ruleEvaluationLogic>or</ruleEvaluationLogic>
		    <ruleList>
			<compareText text="${machine_id}" logic="equals" value=""/>
			<regExMatch text="${machine_id}" logic="does_not_match" pattern="^([A-Fa-f0-9\-]*)$"/>
		    </ruleList>
		</setInstallerVariable>
	    </actionList>
	    <ruleList>
		<compareText logic="equals" text="${platform_name}" value="windows" />
		<compareText logic="equals" text="${machine_id}" value=""/>
	    </ruleList>
	</actionGroup>

        <setInstallerVariableFromScriptOutput name="machine_id" showMessageOnError="0" exec="uuidgen" abortOnError="0">
           <onErrorActionList>
              <!-- User predefined value, if uuidgen does not exist/could not generate the uuid -->
              <setInstallerVariable name="machine_id" value="16a874e6-241e-44ae-b27e-74aecded209a"/>
           </onErrorActionList>
	   <ruleList>
		<compareText text="${machine_id}" logic="equals" value=""/>
		<compareText logic="does_not_equal" text="${platform_name}" value="windows" />
	   </ruleList>
        </setInstallerVariableFromScriptOutput>

	<actionGroup>
	    <actionList>
	    
		<!-- Generate UUID -->
		<setInstallerVariableFromScriptOutput
		    name="installation_id"
		    showMessageOnError="0"
		    exec="${system_temp_directory}\registration_plus_${random_number_reg}\UserValidation\dbserver_guid.exe"
		    abortOnError="0"/>

		<setInstallerVariableFromRegEx
		    name="installation_id"
		    text="${installation_id}"
		    pattern="^dbser_guid=([A-Fa-f0-9\-]*)$"
		    substitution="\1"
		    abortOnError="0"
		    showMessageOnError="0">
		    <ruleList>
			<compareText logic="does_not_equal" text="${installation_id}" value=""/>
		    </ruleList>
		</setInstallerVariableFromRegEx>
		<setInstallerVariable name="installation_id" value="16a874e6-241e-44ae-b27e-74aecded209b">
		    <ruleEvaluationLogic>or</ruleEvaluationLogic>
		    <ruleList>
			<compareText text="${installation_id}" logic="equals" value=""/>
			<regExMatch text="${installation_id}" logic="does_not_match" pattern="^([A-Fa-f0-9\-]*)$"/>
		    </ruleList>
		</setInstallerVariable>
	    </actionList>
	    <ruleList>
		<compareText logic="equals" text="${platform_name}" value="windows" />
		<compareText text="${installation_id}" logic="equals" value=""/>
	    </ruleList>
	</actionGroup>

        <setInstallerVariableFromScriptOutput name="installation_id" showMessageOnError="0" exec="uuidgen" abortOnError="0">
           <onErrorActionList>
              <!-- User predefined value, if uuidgen does not exist/could not generate the uuid -->
              <setInstallerVariable name="installation_id" value="16a874e6-241e-44ae-b27e-74aecded209b"/>
           </onErrorActionList>
	   <ruleList>
		<compareText logic="does_not_equal" text="${platform_name}" value="windows" />
		<compareText text="${installation_id}" logic="equals" value=""/>
	   </ruleList>
        </setInstallerVariableFromScriptOutput>

        <!-- LIN/LIN-X64/MAC: Unpack existing-enterprisedb-mail authentication scripts -->
        <actionGroup>
          <actionList>

	    <!-- Calling authentication-hb.jsp page -->
            <logMessage text="Authenticating user ${existingEmail}:MachineID=${machine_id}&amp;InstallationID=${installation_id}&amp;Description=PRODUCT_DESCRIPTION&amp;Version=PRODUCT_VERSION"/>
	    <httpGet>
		<filename>${system_temp_directory}/registration_plus_${random_number_reg}/auth.html</filename>
		<username>${existingEmail}</username>
		<password>${existingPassword}</password>
		<url>BASE_URL/authentication-hb.jsp?MachineID=${machine_id}&amp;InstallationID=${installation_id}&amp;Description=${enc_desc}&amp;Version=PRODUCT_VERSION</url>
		<abortOnError>0</abortOnError>
		<showMessageOnError>0</showMessageOnError>
	    </httpGet>
	    <readFile>
		<name>auth_result</name>
		<path>${system_temp_directory}/registration_plus_${random_number_reg}/auth.html</path>
	    </readFile>
	    <setInstallerVariableFromRegEx>
		<name>statusCode</name>
		<pattern>.*StatusCode=([\d]+).*</pattern>
		<substitution>\1</substitution>
		<text>${auth_result}</text>
	    </setInstallerVariableFromRegEx>
	    <logMessage text="Status Code: ${statusCode}"/>
	    <actionGroup>
	        <actionList>
		    <logMessage text="Retrieving error message: MachineID=${machine_id}&amp;InstallationID=${installation_id}&amp;Description=PRODUCT_DESCRIPTION&amp;Version=PRODUCT_VERSION&amp;InstallerLang=${installation_language_code}&amp;File="/>
		    <httpGet>
			<filename>${system_temp_directory}/registration_plus_${random_number_reg}/error.html</filename>
			<username>${existingEmail}</username>
			<password>${existingPassword}</password>
			<url>BASE_URL/geterror-hb.jsp?MachineID=${machine_id}&amp;InstallationID=${installation_id}&amp;Description=${enc_desc}&amp;Version=PRODUCT_VERSION&amp;InstallerLang=${installation_language_code}&amp;File=</url>
			<abortOnError>0</abortOnError>
			<showMessageOnError>0</showMessageOnError>
		    </httpGet>
		    <readFile>
			<name>error_message</name>
			<path>${system_temp_directory}/registration_plus_${random_number_reg}/error.html</path>
		    </readFile>
		    <stringModify text="${error_message}" variable="error_message" logic="trim"/>
		    <throwError>
			<text>${error_message}</text>
			<ruleList>
			    <stringTest text="${error_message}" type="not_empty"/>
			</ruleList>
		    </throwError>
		    <throwError>
			<text>${msg(registration_plus.ws.internet.not.connected)}</text>
			<abortOnError>0</abortOnError>
			<ruleList>
			    <stringTest text="${error_message}" type="empty"/>
			</ruleList>
		    </throwError>
		    <logMessage text="Error message returned: ${error_message}"/>
		</actionList>
		<ruleList>
		    <compareText value="${statusCode}" text="401" logic="equals"/>
		</ruleList>
	    </actionGroup>
            <httpGet>
                <filename>${system_temp_directory}/registration_plus_${random_number_reg}/bt.html</filename>
	        <username>${existingEmail}</username>
		<password>${existingPassword}</password>
		<url>BASE_URL/sendbeat-hb.jsp?MachineID=${machine_id}&amp;InstallationID=${installation_id}&amp;components=${enc_component}&amp;Version=PRODUCT_VERSION&amp;OS=${enc_os}&amp;SystemArch=${processor_arch}&amp;InstallationSource=COMP</url>
		<abortOnError>0</abortOnError>
		<showMessageOnError>0</showMessageOnError>
	    </httpGet>

          </actionList>
          <ruleList>
            <compareText logic="equals" text="${installer_ui}" value="unattended"/>
          </ruleList>
        </actionGroup>
      </actionList>
      <ruleList>
        <isTrue value="${registration_plus_required}"/>
	<isTrue value="${is_internet_connected}" />
        <compareText logic="equals" text="${iExistingEmail}" value=""/>
      </ruleList>
    </actionGroup>
  </actionList>
</actionGroup>
