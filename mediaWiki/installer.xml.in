<project>
    <!-- Package details -->
    <shortName>mediawiki</shortName>
    <fullName>mediaWiki</fullName>
    <version>PG_VERSION_MEDIAWIKI-PG_BUILDNUM_MEDIAWIKI</version>
    <!-- These options are used on Windows -->
    <startMenuGroupName>${branding}</startMenuGroupName>
    <!-- Product Specific Options -->
    <productDisplayName>${product_fullname} ${productVersion}</productDisplayName>
    <productComments>${product_fullname} ${productVersion}, packaged by EnterpriseDB</productComments>
    <productUrlHelpLink>http://www.enterprisedb.com</productUrlHelpLink>
    <productUrlInfoAbout>http://www.enterprisedb.com</productUrlInfoAbout>
    <!-- The options are used for RPM registration -->
    <description>${product_fullname} ${productVersion} by EnterpriseDB</description>
    <summary>${msg(install.summary)}</summary>
    <vendor>EnterpriseDB</vendor>
    <release>1</release>

    <!-- Installer Size -->
    <width>550</width>
    <height>400</height>

    <!-- Misc package options -->
    <installerFilename>${product_shortname}-${product_version}-${platform_name}.${platform_exec_suffix}</installerFilename>
    <enableRollback>0</enableRollback>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>
    <saveRelativePaths>1</saveRelativePaths>
    <outputDirectory>../output</outputDirectory>
    <uninstallerName>uninstall-${product_shortname}</uninstallerName>
    <uninstallerDirectory>${apachephpinstalldir}</uninstallerDirectory>
    <unattendedModeUI>minimal</unattendedModeUI>
    <compressionAlgorithm>lzma</compressionAlgorithm>
    <installationLogFile>${system_temp_directory}/install-${product_shortname}.log</installationLogFile>
    <uninstallationLogFile>${system_temp_directory}/uninstall-${product_shortname}.log</uninstallationLogFile>
    <allowWindowResize>1</allowWindowResize>

    <!-- Images -->
    <disableSplashScreen>1</disableSplashScreen>
    <leftImage>../resources/pg-side.png</leftImage>
    <productDisplayIcon>${installdir}/mediaWiki/scripts/images/logo.ico</productDisplayIcon>
    <windowsExecutableIcon>resources/logo.ico</windowsExecutableIcon>

    <!-- i18n files for the UI -->
    <allowedLanguages>en</allowedLanguages>
    <customLanguageFileList>
        <language>
            <code>en</code>
            <encoding>iso8859-1</encoding>
            <file>i18n/en.lng</file>
        </language>
    </customLanguageFileList>

    <preShowHelpActionList>
        <setInstallerVariable name="pghost" value="localhost" />
        <setInstallerVariable name="defaultuser" value="postgres"/>
        <setInstallerVariable name="defaultpassword" value=""/>
    </preShowHelpActionList>

    <!-- Prebuild Actons-->
    <preBuildActionList>
      <setInstallerVariable name="originalplatform" value="${platform_name}"/>
      <setInstallerVariable name="originalplatform" value="linux-x32">
          <ruleList>
              <compareText text="${platform_name}" value="linux"/>
          </ruleList>
      </setInstallerVariable>
     </preBuildActionList>
    <!-- Initialisation actions -->
    <initializationActionList>
	<setInstallerVariable name="productVersion" persist="1" value="PG_VERSION_MEDIAWIKI" />
	<!-- Abort Installation as trying to  run a 32-bit installer on 64-bit machine -->
        <throwError>
          <customErrorMessage>${msg(platform.not.match)}</customErrorMessage>
          <text>Unknown Error</text>
          <ruleList>
            <platformTest type="linux-x64"/>
            <compareText text="${originalplatform}" value="linux-x32"/>
          </ruleList>
        </throwError>
        <!-- Set the Apache Home -->
        <setInstallerVariable name="apachehome" value="">
            <persist>0</persist>
        </setInstallerVariable>
        <setInstallerVariable name="apacheport" value="8080">
            <persist>0</persist>
        </setInstallerVariable>
        <!-- Set the php Home -->
        <setInstallerVariable name="phphome" value="">
            <persist>0</persist>
        </setInstallerVariable>
        <!-- Set the pghost varaible to localhost -->
        <setInstallerVariable name="pghost" value="localhost">
            <persist>0</persist>
        </setInstallerVariable>
        <!-- Set the mediaWiki version(if exists) -->
        <setInstallerVariable name="mediaWikiVersion" value="">
            <persist>0</persist>
        </setInstallerVariable>
        <!-- Set the default values -->
        <setInstallerVariable name="pgdatabase" value=""/>
        <setInstallerVariable name="pgtempdbname" value=""/>
        <setInstallerVariable name="defaultuser" value="postgres"/>
        <setInstallerVariable name="defaultpassword" value=""/>
        <setInstallerVariable name="dbexist" value=""/>
        <setInstallerVariable name="userexist" value=""/>

        <!-- Set the default values for unattended mode -->
        <actionGroup>
            <actionList>
                <setInstallerVariable name="defaultuser" value="postgres"/>
                <setInstallerVariable name="defaultpassword" value="postgres"/>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${installer_ui}</text>
                    <value>unattended</value>
                </compareText>
            </ruleList>
        </actionGroup>
    </initializationActionList>
    <!-- Preinstallation actions -->
    <preInstallationActionList>
        <!-- Creates the ini file if not exits -->
        <touchFile path="/etc/postgres-reg.ini">
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </touchFile>
        <!-- LIN & MAC : Check Previous Installation of mediaWiki -->
        <actionGroup>
            <actionList>
                <iniFileGet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Version</key>
                    <variable>mediaWikiVersion</variable>
                </iniFileGet>
                <iniFileGet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Branding</key>
                    <variable>iBranding</variable>
                </iniFileGet>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- WIN: Check Previous Installation of mediaWiki -->
        <actionGroup>
            <actionList>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\mediaWiki</key>
                    <name>Version</name>
                    <variable>mediaWikiVersion</variable>
                </registryGet>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\mediaWiki</key>
                    <name>Branding</name>
                    <variable>iBranding</variable>
                </registryGet>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- WIN : Set the Apache Home , Php Home and Apache Port(default 8080), ApachePhp Installation Directory from registry. -->
        <!--    ApachePhp Installation would have set these values -->
        <actionGroup>
            <actionList>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>APACHE_HOME</name>
                    <variable>apachehome</variable>
                </registryGet>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>APACHE_PORT</name>
                    <variable>apacheport</variable>
                </registryGet>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>PHP_HOME</name>
                    <variable>phphome</variable>
                </registryGet>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\ApachePhp</key>
                    <name>Location</name>
                    <variable>apachephpinstalldir</variable>
                </registryGet>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- LIN & MAC : Set the Apache Home , Php Home and Apache Port(default 8080), ApachePhp Installation Directory from registry. -->
        <!--    ApachePhp Installation would have set these values -->
        <actionGroup>
            <actionList>
                <iniFileGet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>ApachePhp</section>
                    <key>APACHE_HOME</key>
                    <variable>apachehome</variable>
                </iniFileGet>
                <iniFileGet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>ApachePhp</section>
                    <key>APACHE_PORT</key>
                    <variable>apacheport</variable>
                </iniFileGet>
                <iniFileGet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>ApachePhp</section>
                    <key>PHP_HOME</key>
                    <variable>phphome</variable>
                </iniFileGet>
                <iniFileGet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>ApachePhp</section>
                    <key>InstallationDirectory</key>
                    <variable>apachephpinstalldir</variable>
                </iniFileGet>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- Abort Installation as Apache Home not found -->
        <actionGroup>
            <actionList>
                <throwError>
                    <customErrorMessage>${msg(error.apache.notfound)}</customErrorMessage>
                    <text>Unknown Error</text>
                </throwError>
            </actionList>
            <ruleList>
                <compareTextLength>
                    <length>0</length>
                    <logic>equals</logic>
                    <text>${apachehome}</text>
                </compareTextLength>
            </ruleList>
        </actionGroup>
        <!-- Abort Installation as php Home not found -->
        <actionGroup>
            <actionList>
                <throwError>
                    <customErrorMessage>${msg(error.php.notfound)}</customErrorMessage>
                    <text>Unknown Error</text>
                </throwError>
            </actionList>
            <ruleList>
                <compareTextLength>
                    <length>0</length>
                    <logic>equals</logic>
                    <text>${phphome}</text>
                </compareTextLength>
            </ruleList>
        </actionGroup>

	<!-- If there appears to be an existing installation, with no Branding value. -->
	<!-- force the default value. Otherwise, set the branding to whatever we read, -->
	<!-- or, set the default -->

	<!-- Existing, old install (version, but no branding) -->
	<setInstallerVariable>
		<name>branding</name>
		<persist>0</persist>
		<value>PostgreSQL</value>
		<ruleList>
			<compareText>
				<logic>does_not_equal</logic>
				<text>${mediaWikiVersion}</text>
				<value></value>
			</compareText>
			<compareText>
				<logic>equals</logic>
				<text>${iBranding}</text>
				<value></value>
			</compareText>
		</ruleList>
	</setInstallerVariable>

	<!-- Existing install, with branding -->
	<setInstallerVariable>
		<name>branding</name>
		<persist>0</persist>
		<value>${iBranding}</value>
		<ruleList>
			<compareText>
				<logic>does_not_equal</logic>
				<text>${iBranding}</text>
				<value></value>
			</compareText>
		</ruleList>
	</setInstallerVariable>

	<!-- New install, nothing set on the command line -->
	<setInstallerVariable>
		<name>branding</name>
		<persist>0</persist>
		<value>Postgres Plus Add-ons</value>
		<ruleList>
			<compareText>
				<logic>equals</logic>
				<text>${branding}</text>
				<value></value>
			</compareText>
		</ruleList>
	</setInstallerVariable>

        <logMessage>
            <text>Using branding: ${branding}</text>
        </logMessage>

        <actionGroup>
            <actionList>
                <setInstallerVariable name="installationType" value="upgrade" />
            </actionList>
            <ruleList>
                <compareText>
                    <text>${mediaWikiVersion}</text>
                    <logic>does_not_equal</logic>
                    <value/>
                </compareText>
            </ruleList>
        </actionGroup>

        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfileslinux</folder>
            <destination>${system_temp_directory}</destination>
            <component>mediaWiki</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>linux</value>
                </compareText>
            </ruleList>
        </unpackDirectory>
        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfileslinux-x64</folder>
            <destination>${system_temp_directory}</destination>
            <component>mediaWiki</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>linux-x64</value>
                </compareText>
            </ruleList>
        </unpackDirectory>
        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfilesosx</folder>
            <destination>${system_temp_directory}</destination>
            <component>mediaWiki</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>osx</value>
                </compareText>
            </ruleList>
        </unpackDirectory>
        <unpackDirectory>
            <origin>instscripts</origin>
            <folder>installfileswindows</folder>
            <destination>${system_temp_directory}</destination>
            <component>mediaWiki</component>
            <ruleList>
                <compareText>
                     <text>${platform_name}</text>
                     <logic>equals</logic>
                     <value>windows</value>
                </compareText>
            </ruleList>
        </unpackDirectory>

        <!-- Validate the PostgreSQL Server Details in unattended mode -->
        <actionGroup>
            <actionList>
                <setEnvironmentVariable name="PGHOST" value="${pghost}"/>
                <setEnvironmentVariable name="PGUSER" value="${pguser}"/>
                <setEnvironmentVariable name="PGPASSWORD" value="${pgpassword}"/>
                <setEnvironmentVariable name="PGPORT" value="${pgport}"/>
                <setEnvironmentVariable name="PGDATABASE" value=""/>
                <setEnvironmentVariable name="LD_LIBRARY_PATH" value="${system_temp_directory}/instscripts"/>
                <setInstallerVariable name="pgtempdbname" value=""/>
                <setInstallerVariable name="connection" value=""/>

                <setInstallerVariable name="psql_executable" value="${system_temp_directory}/instscripts/psql"/>
                <setInstallerVariable name="psql_executable" value="${system_temp_directory}\instscripts\psql.exe">
                    <ruleList>
                        <compareText logic="equals" text="${platform_name}" value="windows"/>
                    </ruleList>
                </setInstallerVariable>

                <!-- Check connection against the database, if given as the command-line argument -->
                <actionGroup>
                    <actionList>
                        <setInstallerVariableFromScriptOutput name="connection"
                                workingDirectory="${system_temp_directory}/instscripts"
                                abortOnError="0" showMessageOnError="0"
                                exec="${psql_executable}"
                                execArgs="-l -d &quot;${pgdatabase}&quot;"/>
                        <stringModify text="${connection}" variable="connection" logic="trim"/>
                    </actionList>
                    <ruleList>
                        <compareText logic="does_not_equal" text="${pgdatabase}" value=""/>
                    </ruleList>
                </actionGroup>

                <foreach variables="dbname">
                    <values>postgres edb template1</values>
                    <actionList>
                        <setInstallerVariableFromScriptOutput name="connection"
                                workingDirectory="${system_temp_directory}/instscripts"
                                abortOnError="0" showMessageOnError="0">
                            <exec>${psql_executable}</exec>
                            <execArgs>-l -d ${dbname}</execArgs>
                            <ruleList>
                                <compareText logic="equals" text="${connection}" value=""/>
                            </ruleList>
                        </setInstallerVariableFromScriptOutput>
                        <stringModify text="${connection}" variable="connection" logic="trim"/>
                        <setInstallerVariable name="pgtempdbname" value="${dbname}">
                            <ruleList>
                                <compareText logic="does_not_equal" text="${connection}" value=""/>
                                <compareText logic="equals" text="${pgtempdbname}" value=""/>
                            </ruleList>
                        </setInstallerVariable>
                    </actionList>
                    <ruleList>
                        <compareText logic="equals" text="${pgdatabase}" value=""/>
                    </ruleList>
                </foreach>

                <throwError text="${program_stderr}">
                    <ruleList>
                        <compareText logic="equals" text="${connection}" value=""/>
                    </ruleList>
                </throwError>

                <setEnvironmentVariable name="PGDATABASE" value="${pgtempdbname}"/>
                <setEnvironmentVariable name="PGDATABASE" value="${pgdatabase}">
                    <ruleList>
                        <compareText logic="does_not_equal" text="${pgdatabase}" value=""/>
                    </ruleList>
                </setEnvironmentVariable>

                <!-- Check the user permissions -->
                <setInstallerVariableFromScriptOutput name="is_superuser"
                        workingDirectory="${system_temp_directory}/instscripts"
                        abortOnError="0" showMessageOnError="0">
                    <exec>${psql_executable}</exec>
                    <execArgs>-t -A -c "select CASE WHEN u.usesuper THEN 1 ELSE 0 END FROM pg_catalog.pg_user u WHERE u.usename=current_user"</execArgs>
                </setInstallerVariableFromScriptOutput>
                <throwError text="${msg(mediawiki.user.not.superuser)}">
                    <ruleList>
                        <isFalse value="${is_superuser}"/>
                    </ruleList>
                </throwError>

                <!-- Check db exists -->
                <setInstallerVariable name="dbexist" value=""/>
                <setInstallerVariableFromScriptOutput name="dbexist"
                        workingDirectory="${system_temp_directory}/instscripts"
                        abortOnError="0" showMessageOnError="0">
                    <exec>${psql_executable}</exec>
                    <execArgs>-t -A -c "SELECT count(*) FROM pg_catalog.pg_database d WHERE d.datname='mediawiki'"</execArgs>
                </setInstallerVariableFromScriptOutput>

                <!-- Check user exists -->
                <setInstallerVariable name="userexist" value=""/>
                <setInstallerVariableFromScriptOutput name="userexist"
                        workingDirectory="${system_temp_directory}/instscripts"
                        abortOnError="0" showMessageOnError="0">
                    <exec>${psql_executable}</exec>
                    <execArgs>-t -A -c "SELECT count(*) FROM pg_catalog.pg_user u WHERE u.usename='mediawikiuser'"</execArgs>
                </setInstallerVariableFromScriptOutput>

            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${mediaWikiVersion}</text>
                    <value></value>
                </compareText>
                <compareText>
                    <logic>equals</logic>
                    <text>${installer_ui}</text>
                    <value>unattended</value>
                </compareText>
            </ruleList>
        </actionGroup>

        <!-- Ask user whether he wants to stop apache and continue -->
        <showQuestion>
           <text>${msg(apache.restart.question)}</text>
           <variable>response</variable>
           <ruleList>
              <fileTest>
                 <path>${apachehome}/conf/addons/application_secure.conf</path>
                 <condition>not_exists</condition>
              </fileTest>
           </ruleList>
        </showQuestion>

        <!-- Exit the installation if the user selects 'no' -->
        <exit>
          <exitCode>0</exitCode>
          <ruleList>
              <compareText>
                 <logic>equals</logic>
                 <text>${response}</text>
                 <value>no</value>
              </compareText>
           </ruleList>
        </exit>

        <!-- Lin | MAC :Stop the apache server -->
        <runProgram>
           <program>${apachehome}/bin/apachectl</program>
           <programArguments>"stop"</programArguments>
           <workingDirectory>${apachehome}/bin</workingDirectory>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.stop.apache)}</customErrorMessage>
           <abortOnError>1</abortOnError>
           <ruleList>
               <compareText>
                   <logic>does_not_equal</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </runProgram>

        <!-- WIN :Stop the apache server -->
        <stopWindowsService>
           <serviceName>EnterpriseDB ApachePHP</serviceName>
           <abortOnError>1</abortOnError>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.stop.apache)}</customErrorMessage>
           <ruleList>
               <compareText>
                   <logic>equals</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </stopWindowsService>

        <!-- WIN: Set the Installation Directory -->
        <actionGroup>
            <actionList>
                <setInstallerVariable name="installdir" value="${apachehome}\www">
                    <persist>0</persist>
                </setInstallerVariable>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- LIN & MAC : Set the Installation Directory -->
        <actionGroup>
            <actionList>
                <setInstallerVariable name="installdir" value="${apachehome}/www">
                    <persist>0</persist>
                </setInstallerVariable>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- LIN & MAC : Deleting the config file -->
        <actionGroup>
            <actionList>
                <deleteFile>
                    <path>${installdir}/mediaWiki/config/LocalSettings.php</path>
                </deleteFile>
            </actionList>
            <ruleList>
                <fileExists>
                    <path>${installdir}/mediaWiki/config/LocalSettings.php</path>
                </fileExists>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- WIN: Deleting the config file -->
        <actionGroup>
            <actionList>
                <deleteFile>
                    <path>${installdir}\mediaWiki\config\LocalSettings.php</path>
                </deleteFile>
            </actionList>
            <ruleList>
                <fileExists>
                    <path>${installdir}\mediaWiki\config\LocalSettings.php</path>
                </fileExists>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>

        <!-- Win: deleting installation helper files (Clean-up for upgrade) -->
        <deleteFile>
            <path>${installdir}\mediaWiki\install.bat</path>
            <ruleList>
                <compareText>
                    <text>${mediaWikiVersion}</text>
                    <logic>does_not_equal</logic>
                    <value/>
                </compareText>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>equals</logic>
                    <value>windows</value>
                </compareText>
                <fileExists>
                    <path>${installdir}\mediaWiki\install.bat</path>
                </fileExists>
            </ruleList>
        </deleteFile>

        <deleteFile>
            <path>${installdir}\mediaWiki\launchMediaWiki.vbs</path>
            <ruleList>
                <compareText>
                    <text>${mediaWikiVersion}</text>
                    <logic>does_not_equal</logic>
                    <value/>
                </compareText>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>equals</logic>
                    <value>windows</value>
                </compareText>
                <fileExists>
                    <path>${installdir}\mediaWiki\launchMediaWiki.vbs</path>
                </fileExists>
            </ruleList>
        </deleteFile>

        <!-- LIN & MAC: Deleting the uninstaller from www context -->
        <actionGroup>
            <actionList>
                <deleteFile>
                    <path>${installdir}/mediaWiki/uninstall</path>
                </deleteFile>
            </actionList>
            <ruleList>
                <compareText>
                    <text>${mediaWikiVersion}</text>
                    <logic>does_not_equal</logic>
                    <value/>
                </compareText>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>does_not_equal</logic>
                    <value>windows</value>
                </compareText>
                <fileExists>
                    <path>${installdir}/mediaWiki/uninstall</path>
                </fileExists>
            </ruleList>
        </actionGroup>

        <!-- WIN: Deleting the uninstaller from www context -->
        <actionGroup>
            <actionList>
                <deleteFile>
                    <path>${installdir}\mediaWiki\uninstall.exe</path>
                </deleteFile>
            </actionList>
            <ruleList>
                <compareText>
                    <text>${mediaWikiVersion}</text>
                    <logic>does_not_equal</logic>
                    <value/>
                </compareText>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>equals</logic>
                    <value>windows</value>
                </compareText>
                <fileExists>
                    <path>${installdir}\mediaWiki\uninstall.exe</path>
                </fileExists>
            </ruleList>
        </actionGroup>
    </preInstallationActionList>

    <readyToInstallActionList>
        <setInstallerVariable name="pgdatabase" value="${pgtempdbname}">
            <ruleList>
                <compareText logic="equals" text="${pgdatabase}" value=""/>
            </ruleList>
        </setInstallerVariable>
        <setEnvironmentVariable name="PGDATABASE" value="${pgdatabase}"/>
    </readyToInstallActionList>

    <!-- Post installation actions -->
    <postInstallationActionList>

	    <substitute>
	        <files>${installdir}/mediaWiki/config/index.php</files>
	        <substitutionList>
	            <substitution>
	                <pattern>@@HOST@@</pattern>
	                <value>${pghost}</value>
	            </substitution>
	            <substitution>
	                <pattern>@@PORT@@</pattern>
	                <value>${pgport}</value>
	            </substitution>
	        </substitutionList>
	    </substitute>

        <!-- LIN & MAC : Write the mediaWiki Info to INI File -->
        <actionGroup>
            <actionList>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Description</key>
                    <value>${msg(install.summary)}</value>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>InstallationDirectory</key>
                    <value>${installdir}/mediaWiki</value>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Version</key>
                    <value>${product_version}</value>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Branding</key>
                    <value>${branding}</value>
                </iniFileSet>
            </actionList>
            <ruleList>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>does_not_equal</logic>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <registrySet>
            <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\mediaWiki</key>
            <name>Branding</name>
            <value>${branding}</value>
            <ruleList>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>equals</logic>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </registrySet>

        <setEnvironmentVariable name="PGHOST" value="${pghost}"/>
        <setEnvironmentVariable name="PGUSER" value="${pguser}"/>
        <setEnvironmentVariable name="PGPASSWORD" value="${pgpassword}"/>
        <setEnvironmentVariable name="PGPORT" value="${pgport}"/>
        <setEnvironmentVariable name="PGDATABASE" value="${pgdatabase}"/>
        <setEnvironmentVariable name="LD_LIBRARY_PATH" value="${system_temp_directory}/instscripts/"/>

        <!-- Create Role and database -->
        <actionGroup>
            <actionList>
                <runProgram workingDirectory="${system_temp_directory}/instscripts"
                      program="${psql_executable}">
                    <programArguments>-t -A -c "CREATE ROLE mediawikiuser PASSWORD 'mediawikiuser' NOSUPERUSER CREATEDB NOCREATEROLE INHERIT LOGIN"</programArguments>
                </runProgram>
                <runProgram workingDirectory="${system_temp_directory}/instscripts"
                      program="${psql_executable}">
                    <programArguments>-t -A -c "CREATE DATABASE mediawiki OWNER mediawikiuser"</programArguments>
                </runProgram>
            </actionList>
            <ruleList>
                <isFalse value="${dbexist}"/>
                <isFalse value="${userexist}"/>
                <compareText text="${mediaWikiVersion}" logic="equals" value=""/>
            </ruleList>
        </actionGroup>

        <!-- LIN & MAC: Create Menu Shortcuts -->
        <actionGroup>
            <actionList>
                <runProgram>
                    <program>${installdir}/mediaWiki/installer/mediaWiki/createshortcuts.sh</program>
                    <programArguments>"${installdir}" "${branding}"</programArguments>
                    <progressText>${msg(progress.text.creating.shortcuts)}</progressText>
                    <workingDirectory>${installdir}/mediaWiki/installer/mediaWiki</workingDirectory>
                    <abortOnError>0</abortOnError>
                    <showMessageOnError>0</showMessageOnError>
                </runProgram>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>

        <!-- Getting the Version Installed minus the buildnum -->
        <setInstallerVariableFromRegEx>
            <name>mediaWikiVersionInstalled</name>
            <text>${mediaWikiVersion}</text>
            <pattern>([0-9]*)-[0-9]*$</pattern>
            <substitution>\1</substitution>
            <ruleList>
              <compareText>
                 <logic>does_not_equal</logic>
                 <text>${mediaWikiVersion}</text>
                 <value/>
              </compareText>
            </ruleList>
        </setInstallerVariableFromRegEx>

        <!-- Upgrade From Old Windows Installation -->
        <actionGroup>
            <actionList>
                <registryDelete>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\mediaWiki ${mediaWikiVersionInstalled}</key>
                </registryDelete>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${mediaWikiVersion}</text>
                    <value/>
                </compareText>
            </ruleList>
        </actionGroup>

       <!-- LIN| MAC: Finding whether the include line is already there in the httpd.conf file -->
       <setInstallerVariableFromScriptOutput>
          <exec>grep</exec>
          <execArgs>"include conf/addons/\*\.conf" "${apachehome}/conf/httpd.conf"</execArgs>
          <name>confText</name>
          <showMessageOnError>0</showMessageOnError>
            <abortOnError>0</abortOnError>
            <ruleList>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>does_not_equal</logic>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </setInstallerVariableFromScriptOutput>

        <!-- WIN: Finding whether the include line is already there in the httpd.conf file -->
        <setInstallerVariableFromScriptOutput>
          <exec>find</exec>
          <execArgs>"include conf\addons\*.conf" "${apachehome}\conf\httpd.conf"</execArgs>
          <name>confText</name>
          <showMessageOnError>0</showMessageOnError>
            <abortOnError>0</abortOnError>
            <ruleList>
                <compareText>
                    <text>${platform_name}</text>
                    <logic>equals</logic>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </setInstallerVariableFromScriptOutput>

         <!-- WIN: Modifying the httpd.conf file -->
        <addTextToFile>
           <file>${apachehome}\conf\httpd.conf</file>
           <text>include conf\addons\*.conf</text>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${confText}</text>
                    <value/>
                </compareText>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
           </ruleList>
        </addTextToFile>

        <!-- Linux| MAC: Modifying the httpd.conf file -->
        <addTextToFile>
           <file>${apachehome}/conf/httpd.conf</file>
           <text>include conf/addons/*.conf</text>
           <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${confText}</text>
                    <value/>
                </compareText>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
           </ruleList>
        </addTextToFile>

        <!-- Creating a addons directory for additional conf files -->
        <createDirectory path="${apachehome}/conf/addons" >
           <ruleList>
             <fileTest>
                 <path>${apachehome}/conf/addons</path>
                 <condition>not_exists</condition>
             </fileTest>
           </ruleList>
        </createDirectory>

        <!-- Linux | MAC: Adding a application secure conf which prohibit directory listings of applications under www context -->
        <actionGroup>
           <actionList>
             <touchFile path="${apachehome}/conf/addons/application_secure.conf" />
             <addTextToFile>
                   <file>${apachehome}/conf/addons/application_secure.conf</file>
                   <text>
&lt;Directory "${apachehome}/www/*/scripts"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;

&lt;Directory "${apachehome}/www/*/installer"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;
                   </text>
             </addTextToFile>
           </actionList>
           <ruleList>
             <fileTest>
                 <path>${apachehome}/conf/addons/application_secure.conf</path>
                 <condition>not_exists</condition>
             </fileTest>
             <compareText>
                  <logic>does_not_equal</logic>
                  <text>${platform_name}</text>
                  <value>windows</value>
             </compareText>
           </ruleList>
        </actionGroup>

        <!-- WIN: Adding a application secure conf which prohibit directory listings of applications under www context -->
        <actionGroup>
           <actionList>
             <touchFile path="${apachehome}\conf\addons\application_secure.conf" />
             <addTextToFile>
                   <file>${apachehome}\conf\addons\application_secure.conf</file>
                   <text>
&lt;Directory "${apachehome}\www\*\scripts"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;

&lt;Directory "${apachehome}\www\*\installer"&gt;
   Options -Indexes -FollowSymLinks
   Order allow,deny
   Deny from all
&lt;/Directory&gt;
                   </text>
             </addTextToFile>
           </actionList>
           <ruleList>
             <fileTest>
                 <path>${apachehome}\conf\addons\application_secure.conf</path>
                 <condition>not_exists</condition>
             </fileTest>
             <compareText>
                  <logic>equals</logic>
                  <text>${platform_name}</text>
                  <value>windows</value>
             </compareText>
           </ruleList>
        </actionGroup>

        <!-- Lin | MAC :Start the apache server -->
        <runProgram>
           <program>${apachehome}/bin/apachectl</program>
           <programArguments>"start"</programArguments>
           <workingDirectory>${apachehome}/bin</workingDirectory>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.stop.apache)}</customErrorMessage>
           <abortOnError>0</abortOnError>
           <ruleList>
               <compareText>
                   <logic>does_not_equal</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </runProgram>

        <!-- WIN :Start the apache server -->
        <startWindowsService>
           <serviceName>EnterpriseDB ApachePHP</serviceName>
           <abortOnError>1</abortOnError>
           <showMessageOnError>1</showMessageOnError>
           <customErrorMessage>${msg(error.start.apache)}</customErrorMessage>
           <ruleList>
               <compareText>
                   <logic>equals</logic>
                   <text>${platform_name}</text>
                   <value>windows</value>
               </compareText>
               <compareText>
                   <logic>equals</logic>
                   <text>${response}</text>
                   <value>yes</value>
               </compareText>
           </ruleList>
        </startWindowsService>
        <deleteFile>
            <path>${installdir}/mediaWiki/instscripts</path>
        </deleteFile>
        <deleteFile>
            <path>${system_temp_directory}/instscripts</path>
        </deleteFile>

    </postInstallationActionList>

    <postUninstallerCreationActionList>
        <actionGroup>
            <actionList>
		<showInfo text="${msg(db.create.info)}"/>
            </actionList>
            <ruleList>
                <isFalse value="${dbexist}"/>
                <isFalse value="${userexist}"/>
                <compareText text="${mediaWikiVersion}" logic="equals" value=""/>
            </ruleList>
        </actionGroup>
    </postUninstallerCreationActionList>

    <!-- preUninstallation actions -->
    <preUninstallationActionList>
        <!-- Deleting the config file -->
        <actionGroup>
            <actionList>
                <deleteFile>
                    <path>${installdir}/mediaWiki/LocalSettings.php</path>
                </deleteFile>
            </actionList>
            <ruleList>
                <fileExists>
                    <path>${installdir}/mediaWiki/LocalSettings.php</path>
                </fileExists>
            </ruleList>
        </actionGroup>
        <!-- Deleting the config file -->
        <actionGroup>
            <actionList>
                <deleteFile>
                    <path>${installdir}/mediaWiki/config/LocalSettings.php</path>
                </deleteFile>
            </actionList>
            <ruleList>
                <fileExists>
                    <path>${installdir}/mediaWiki/config/LocalSettings.php</path>
                </fileExists>
            </ruleList>
        </actionGroup>
        <!-- LIN & MAC: Unsetting the mediaWiki values in the ini file -->
        <actionGroup>
            <actionList>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Description</key>
                    <value/>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>InstallationDirectory</key>
                    <value/>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Version</key>
                    <value/>
                </iniFileSet>
                <iniFileSet>
                    <file>/etc/postgres-reg.ini</file>
                    <section>mediaWiki</section>
                    <key>Branding</key>
                    <value/>
                </iniFileSet>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${platform_name}</text>
                    <value>windows</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- LIN : Remove Menu Shortcuts -->
        <actionGroup>
            <actionList>
                <runProgram>
                    <program>${installdir}/mediaWiki/installer/mediaWiki/removeshortcuts.sh</program>
                    <programArguments>"${installdir}" "${branding}"</programArguments>
                    <workingDirectory>${installdir}/mediaWiki/installer/mediaWiki</workingDirectory>
                </runProgram>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>contains</logic>
                    <text>${platform_name}</text>
                    <value>linux</value>
                </compareText>
            </ruleList>
        </actionGroup>
        <!-- MAC: Remove Menu shortcuts -->
        <actionGroup>
            <actionList>
                <deleteFile>
                    <path>/Applications/${branding}/mediaWiki.app</path>
                </deleteFile>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>equals</logic>
                    <text>${platform_name}</text>
                    <value>osx</value>
                </compareText>
            </ruleList>
        </actionGroup>
    </preUninstallationActionList>
    <!-- Post un-installation actions -->
    <postUninstallationActionList>
        <!-- Promt user about the database and role drop/deletion -->
        <showInfo>
            <text>${msg(db.drop.info)}</text>
        </showInfo>
    </postUninstallationActionList>
    <!-- Components -->
    <componentList>
        <component>
            <name>mediaWiki</name>
            <description>mediaWiki</description>
            <canBeEdited>0</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <folderList>
                <!-- LIN: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileslinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux/mediaWiki</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Installation Files</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>installfileslinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux/installer</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>staging/linux/instscripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Launch And Menu Scripts</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>menuandlaunchfileslinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux/scripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <!-- LIN-X64: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileslinux-x64</name>
                    <platforms>linux-x64</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux-x64/mediaWiki</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Installation Files</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>installfileslinux-x64</name>
                    <platforms>linux-x64</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux-x64/installer</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>staging/linux-x64/instscripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Launch And Menu Scripts</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>menuandlaunchfileslinux-x64</name>
                    <platforms>linux-x64</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/linux-x64/scripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <!-- WIN: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/windows/mediaWiki</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Installation Files</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>installfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/windows/instscripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Launch And Menu Scripts</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>menuandlaunchfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/windows/scripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <!-- MAC : Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfilesosx</name>
                    <platforms>osx</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/osx/mediaWiki</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Installation Files</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>installfilesosx</name>
                    <platforms>osx</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/osx/installer</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>staging/osx/instscripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Launch And Menu Scripts</description>
                    <destination>${installdir}/mediaWiki</destination>
                    <name>menuandlaunchfilesosx</name>
                    <platforms>osx</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/osx/scripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
            </folderList>
            <!-- WIN: Start Menu -->
            <startMenuShortcutList>
                <!-- Launch mediaWiki -->
                <startMenuShortcut>
                    <comment>EnterpriseDB mediaWiki</comment>
                    <name>mediaWiki</name>
                    <runInTerminal>0</runInTerminal>
                    <windowsExec>wscript</windowsExec>
                    <windowsExecArgs>//NoLogo "${installdir}\mediaWiki\scripts\launchMediaWiki.vbs"</windowsExecArgs>
                    <windowsIcon>${installdir}\mediaWiki\scripts\images\logo.ico</windowsIcon>
                </startMenuShortcut>
            </startMenuShortcutList>
        </component>
    </componentList>
    <parameterList>
	<stringParameter name="originalplatform" ask="0" cliOptionShow="0"/>
	<stringParameter name="branding" cliOptionName="branding" ask="0" cliOptionShow="0"/>
        <!-- PostgreSQL Server Details Verification Page -->
        <parameterGroup>
            <name>pgdetails</name>
            <title>${msg(pgplus.details.title)}</title>
            <explanation>${msg(pgplus.details.explanation)}</explanation>
            <value/>
            <default/>
            <parameterList>
                <!-- Postgres Host(Default localhost) -->
                <stringParameter>
                    <name>pghost</name>
                    <description>Host</description>
                    <explanation/>
                    <value/>
                    <default/>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                <!-- Postgres Port(Default 5432) -->
                <stringParameter>
                    <name>pgport</name>
                    <description>Port</description>
                    <explanation/>
                    <value/>
                    <default>5432</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                <!-- Postgres User -->
                <stringParameter>
                    <name>pguser</name>
                    <description>User Name</description>
                    <explanation/>
                    <value/>
                    <default>${defaultuser}</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                </stringParameter>
                <!-- Postgres User Password -->
                <passwordParameter>
                    <name>pgpassword</name>
                    <title>Password</title>
                    <description>Password</description>
                    <explanation/>
                    <value/>
                    <default>${defaultpassword}</default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <askForConfirmation>0</askForConfirmation>
                    <descriptionRetype/>
                    <width>40</width>
                </passwordParameter>
                <!-- Default database-->
                <stringParameter>
                    <name>pgdatabase</name>
                    <description>Default Database</description>
                    <explanation/>
                    <value/>
                    <cliOptionName>dbname</cliOptionName>
                    <default></default>
                    <allowEmptyValue>1</allowEmptyValue>
                    <width>40</width>
                    <ask>0</ask>
                </stringParameter>
                <!-- PostgreSQL Server Installed? -->
                <booleanParameter>
                    <name>pginstalled</name>
                    <description>PostgreSQL Installed</description>
                    <explanation/>
                    <value>${pginstalled}</value>
                    <default>0</default>
                    <ask>0</ask>
                    <displayStyle>checkbox-right</displayStyle>
                </booleanParameter>
            </parameterList>
            <ruleList>
                <compareText>
                    <text>${mediaWikiVersion}</text>
                    <logic>equals</logic>
                    <value/>
                </compareText>
            </ruleList>
            <!-- Checking the validity of PostgreSQL Server Details -->
            <validationActionList>
                <actionGroup>
                    <actionList>
                        <throwError>
                            <text>${msg(pgplus.blank.error)}</text>
                        </throwError>
                    </actionList>
                    <ruleEvaluationLogic>OR</ruleEvaluationLogic>
                    <ruleList>
                        <compareText>
                            <text>${pghost}</text>
                            <logic>equals</logic>
                            <value/>
                        </compareText>
                        <compareText>
                            <text>${pgport}</text>
                            <logic>equals</logic>
                            <value/>
                        </compareText>
                        <compareText>
                            <text>${pguser}</text>
                            <logic>equals</logic>
                            <value/>
                        </compareText>
                        <compareText>
                            <text>${pgpassword}</text>
                            <logic>equals</logic>
                            <value/>
                        </compareText>
                    </ruleList>
                </actionGroup>
                <throwError>
                    <text>${msg(pgplus.port.error)}</text>
                    <ruleEvaluationLogic>OR</ruleEvaluationLogic>
                    <ruleList>
                        <compareValues>
                            <value1>${pgport}</value1>
                            <logic>less_or_equal</logic>
                            <value2>0</value2>
                        </compareValues>
                        <compareValues>
                            <value1>${pgport}</value1>
                            <logic>greater_or_equal</logic>
                            <value2>65535</value2>
                        </compareValues>
                    </ruleList>
                </throwError>

                <setEnvironmentVariable name="PGHOST" value="${pghost}"/>
                <setEnvironmentVariable name="PGUSER" value="${pguser}"/>
                <setEnvironmentVariable name="PGPASSWORD" value="${pgpassword}"/>
                <setEnvironmentVariable name="PGPORT" value="${pgport}"/>
                <setEnvironmentVariable name="PGDATABASE" value=""/>
                <setEnvironmentVariable name="LD_LIBRARY_PATH" value="${system_temp_directory}/instscripts/"/>
                <setInstallerVariable name="connection" value=""/>
                <setInstallerVariable name="pgtempdbname" value=""/>

                <setInstallerVariable name="psql_executable" value="${system_temp_directory}/instscripts/psql"/>
                <setInstallerVariable name="psql_executable" value="${system_temp_directory}\instscripts\psql.exe">
                    <ruleList>
                        <compareText logic="equals" text="${platform_name}" value="windows"/>
                    </ruleList>
                </setInstallerVariable>

                <!-- Check connection against the database, if given as the command-line argument -->
                <actionGroup>
                    <actionList>
                        <setInstallerVariableFromScriptOutput name="connection"
                                workingDirectory="${system_temp_directory}/instscripts"
                                abortOnError="0" showMessageOnError="0"
                                exec="${psql_executable}"
                                execArgs="-l -d &quot;${pgdatabase}&quot;"/>
                        <stringModify text="${connection}" variable="connection" logic="trim"/>
                    </actionList>
                    <ruleList>
                        <compareText logic="does_not_equal" text="${pgdatabase}" value=""/>
                    </ruleList>
                </actionGroup>

                <foreach variables="dbname">
                    <values>postgres edb template1</values>
                    <actionList>
                        <setInstallerVariableFromScriptOutput name="connection"
                                workingDirectory="${system_temp_directory}/instscripts"
                                abortOnError="0" showMessageOnError="0">
                            <exec>${psql_executable}</exec>
                            <execArgs>-l -d ${dbname}</execArgs>
                            <ruleList>
                                <compareText logic="equals" text="${connection}" value=""/>
                            </ruleList>
                        </setInstallerVariableFromScriptOutput>
                        <stringModify text="${connection}" variable="connection" logic="trim"/>
                        <setInstallerVariable name="pgtempdbname" value="${dbname}">
                            <ruleList>
                                <compareText logic="does_not_equal" text="${connection}" value=""/>
                                <compareText logic="equals" text="${pgtempdbname}" value=""/>
                            </ruleList>
                        </setInstallerVariable>
                    </actionList>
                    <ruleList>
                        <compareText logic="equals" text="${pgdatabase}" value=""/>
                    </ruleList>
                </foreach>

                <throwError text="${program_stderr}">
                    <ruleList>
                        <compareText logic="equals" text="${connection}" value=""/>
                    </ruleList>
                </throwError>

                <setEnvironmentVariable name="PGDATABASE" value="${pgtempdbname}"/>
                <setEnvironmentVariable name="PGDATABASE" value="${pgdatabase}">
                    <ruleList>
                        <compareText logic="does_not_equal" text="${pgdatabase}" value=""/>
                    </ruleList>
                </setEnvironmentVariable>

                <!-- Check the user permissions -->
                <setInstallerVariable name="is_superuser" value=""/>
                <setInstallerVariableFromScriptOutput name="is_superuser"
                        workingDirectory="${system_temp_directory}/instscripts"
                        abortOnError="0" showMessageOnError="0">
                    <exec>${psql_executable}</exec>
                    <execArgs>-t -A -c "select CASE WHEN u.usesuper THEN 1 ELSE 0 END FROM pg_catalog.pg_user u WHERE u.usename=current_user"</execArgs>
                </setInstallerVariableFromScriptOutput>
                <throwError text="${msg(mediawiki.user.not.superuser)}">
                    <ruleList>
                        <isFalse value="${is_superuser}"/>
                    </ruleList>
                </throwError>

                <!-- Check db exists -->
                <setInstallerVariable name="dbexist" value=""/>
                <setInstallerVariableFromScriptOutput name="dbexist"
                        workingDirectory="${system_temp_directory}/instscripts"
                        abortOnError="0" showMessageOnError="0">
                    <exec>${psql_executable}</exec>
                    <execArgs>-t -A -c "SELECT count(*) FROM pg_catalog.pg_database d WHERE d.datname='mediawiki'"</execArgs>
                </setInstallerVariableFromScriptOutput>

                <!-- Check user exists -->
                <setInstallerVariable name="userexist" value=""/>
                <setInstallerVariableFromScriptOutput name="userexist"
                        workingDirectory="${system_temp_directory}/instscripts"
                        abortOnError="0" showMessageOnError="0">
                    <exec>${psql_executable}</exec>
                    <execArgs>-t -A -c "SELECT count(*) FROM pg_catalog.pg_user u WHERE u.usename='mediawikiuser'"</execArgs>
                </setInstallerVariableFromScriptOutput>

                <!-- Inform user about the Existance of database and user -->
                <setInstallerVariable name="response" value=""/>
                <showQuestion text="${msg(db.found.info)}" variable="response">
                    <ruleEvaluationLogic>OR</ruleEvaluationLogic>
                    <ruleList>
                        <isTrue value="${dbexist}"/>
                        <isTrue value="${userexist}"/>
                        <compareText text="${mediaWikiVersion}" logic="does_not_equal" value=""/>
                    </ruleList>
                </showQuestion>

                <!-- Exit the installation if the user wants to quit -->
                <setInstallerVariable name="next_page" value="pgdetails">
                    <ruleList>
                        <compareText logic="equals" value="no" text="${response}"/>
                    </ruleList>
                </setInstallerVariable>
            </validationActionList>
        </parameterGroup>
    </parameterList>
</project>
