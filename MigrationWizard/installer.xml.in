
<project>
    <!-- Package details -->
    <shortName>MigrationWizard</shortName>
    <fullName>MigrationWizard</fullName>
    <version>PG_MIGRATIONWIZARD_VERSION</version>
    
    <!-- These options are used on Windows -->
    <startMenuGroupName>PostgreSQL</startMenuGroupName>

    <!-- Product Specific Options -->
    <productDisplayName>EnterpriseDB ${product_fullname} ${product_version}</productDisplayName>
    <productComments>EnterpriseDB ${product_fullname} ${product_version}</productComments>
    <productUrlHelpLink>http://www.enterprisedb.com</productUrlHelpLink>
    <productUrlInfoAbout>http://www.enterprisedb.com</productUrlInfoAbout>
    
    <!-- The options are used for RPM registration -->
    <description>${product_fullname} ${product_version} by EnterpriseDB</description>
    <summary>${msg(install.summary)}</summary>
    <vendor>EnterpriseDB</vendor>
    <release>1</release>

    <!-- Installer Size -->
    <width>550</width>
    <height>400</height>
    
    <!-- Misc package options -->
    <installerFilename>${product_shortname}-${product_version}-${platform_name}.${platform_exec_suffix}</installerFilename>
    <enableRollback>0</enableRollback>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>	
    <saveRelativePaths>1</saveRelativePaths>
    <outputDirectory>../output</outputDirectory>
    <uninstallerDirectory>${installdir}</uninstallerDirectory>
    <uninstallerName>uninstall-${product_shortname}</uninstallerName>	
    <unattendedModeUI>minimal</unattendedModeUI>
    <compressionAlgorithm>lzma</compressionAlgorithm>
    <installationLogFile>${system_temp_directory}/install-${product_shortname}.log</installationLogFile>
 
    <!-- Images -->
    <leftImage>resources/leftImage.png</leftImage>
    <logoImage>resources/edblogo.png</logoImage>
    <splashImage>resources/splash.png</splashImage>
    <wmImage>resources/edblogo.png</wmImage>
    
    <!-- i18n files for the UI -->
    <customLanguageFileList>
        <language>
            <code>en</code>
            <encoding>iso8859-1</encoding>
            <file>i18n/en.lng</file>
        </language>
    </customLanguageFileList>
   
     
    <!-- Initialisation actions -->
    <initializationActionList>
        
        <!-- Set the MigrationWizard version(if exists) -->
        <setInstallerVariable name="MigrationWizardVersion" value="">
            <persist>0</persist>
        </setInstallerVariable>

        <!-- Detecting Java, Abort if not found -->
	<autodetectJava>
            <promptUser>0</promptUser>
            <validVersionList>
                <validVersion>
                    <maxVersion></maxVersion>
                    <minVersion>1.5.0</minVersion>
                    <requireJDK>0</requireJDK>
                    <vendor></vendor>
                </validVersion>
            </validVersionList>
            <abortOnError>1</abortOnError>
            <showMessageOnError>1</showMessageOnError>
            <customErrorMessage>${msg(java.error)}</customErrorMessage>
       </autodetectJava>

    </initializationActionList>
    
    <!-- Preinstallation actions -->
    <preInstallationActionList>


        <!-- LINUX: Check Previous Installation of MigrationWizard -->
        <actionGroup>
            <actionList>
                <iniFileGet>
                  <file>/etc/postgres-reg.ini</file>  
                  <section>MigrationWizard</section>
                  <key>Version</key>
                  <variable>MigrationWizardVersion</variable>
              </iniFileGet>
            </actionList>            
              <ruleList>
                  <compareText>
                    <logic>contains</logic>
                    <text>${platform_name}</text>
                    <value>linux</value>
                  </compareText>
              </ruleList>
        </actionGroup>

         <!-- Setting the installation type as upgrade if previous installation found -->
        <actionGroup>
            <actionList>
                <setInstallerVariable name="installationType" value="upgrade" />
            </actionList>
            <ruleList>
                <compareText>
                    <logic>does_not_equal</logic>
                    <text>${MigrationWizardVersion}</text>
                    <value></value>
                </compareText>
            </ruleList>
        </actionGroup>

        <!-- WIN: Check Previous Installation of MigrationWizard -->
         <actionGroup>
            <actionList>
                <registryGet>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\EnterpriseDB\MigrationWizard</key>
                    <name>Version</name>
                    <variable>MigrationWizardVersion</variable>
                </registryGet>
            </actionList>
            <ruleList>
              <compareText>
                  <logic>equals</logic>
                  <text>${platform_name}</text>
                  <value>windows</value>
              </compareText>
            </ruleList>
        </actionGroup>

    </preInstallationActionList>
    
    
    <!-- Post installation actions -->
    <postInstallationActionList>
       
        <!-- Write the MigrationWizard Version to INI File -->
        <actionGroup>
            <actionList>
	      <iniFileSet>
                  <file>/etc/postgres-reg.ini</file>
                  <section>MigrationWizard</section>
                  <key>Description</key>
                  <value>${msg(install.summary)}</value>
                </iniFileSet>
                <iniFileSet>
                  <file>/etc/postgres-reg.ini</file>
                  <section>MigrationWizard</section>
                  <key>InstallationDirectory</key>
                  <value>${installdir}</value>
                </iniFileSet>
              <iniFileSet>
                  <file>/etc/postgres-reg.ini</file>  
                  <section>MigrationWizard</section>
                  <key>Version</key>
                  <value>${product_version}</value>
              </iniFileSet>
            </actionList>
            <ruleList>
              <compareText>
                <text>${platform_name}</text>
                <logic>contains</logic>
                <value>linux</value>
              </compareText>
            </ruleList>	
        </actionGroup>
	
        <!-- LIN: Setting the installation directory in the launch script -->
	<actionGroup>
	    <actionList>
		<substitute>
		       <files>${installdir}/scripts/launchMigrationWizard.sh</files>
                       <substitutionList>
                          <substitution>
                            <pattern>@@INSTALLDIR@@</pattern>
                            <value>${installdir}</value>
                           </substitution>
                       </substitutionList>
                 </substitute>
	     </actionList>
	     <ruleList>
              <compareText>
                <text>${platform_name}</text>
                <logic>contains</logic>
                <value>linux</value>
              </compareText>
            </ruleList>
	</actionGroup>

        <!-- LINUX: Create Menu Shortcuts -->
        <actionGroup>
            <actionList>
                <runProgram>
                  <program>${installdir}/installer/MigrationWizard/createshortcuts.sh</program>
                  <programArguments>"${installdir}"</programArguments>
                  <progressText>${msg(progress.text.creating.shortcuts)}</progressText>
                  <abortOnError>1</abortOnError>
                  <showMessageOnError>1</showMessageOnError>
                </runProgram>              
            </actionList>
            <ruleList>
                <compareText>
                  <logic>contains</logic>
                  <text>${platform_name}</text>
                  <value>linux</value>
                </compareText>
            </ruleList>
        </actionGroup>

	<!-- WIN: Setting the installation directory in the launch script -->
        <actionGroup>
            <actionList>
                <substitute>
                       <files>${installdir}\scripts\launchMigrationWizard.bat</files>
                       <substitutionList>
                          <substitution>
                            <pattern>@@INSTALLDIR@@</pattern>
                            <value>${installdir}</value>
                           </substitution>
                       </substitutionList>
                 </substitute>
             </actionList>
             <ruleList>
              <compareText>
                <text>${platform_name}</text>
                <logic>contains</logic>
                <value>windows</value>
              </compareText>
            </ruleList>
        </actionGroup>

    </postInstallationActionList>    

    <!-- preUninstallation actions -->    
    <preUninstallationActionList>
        
        <!-- Unsetting the MigrationWizard values in the ini file -->
        <actionGroup>
            <actionList>
		<iniFileSet>
                  <file>/etc/postgres-reg.ini</file>
                  <section>MigrationWizard</section>
                  <key>Description</key>
                  <value></value>
                </iniFileSet>
                <iniFileSet>
                  <file>/etc/postgres-reg.ini</file>
                  <section>MigrationWizard</section>
                  <key>InstallationDirectory</key>
                  <value></value>
                </iniFileSet>
		<iniFileSet>
                  <file>/etc/postgres-reg.ini</file>
                  <section>MigrationWizard</section>
                  <key>Version</key>
                  <value></value>
	        </iniFileSet>
                <runProgram>
                  <program>${installdir}/installer/MigrationWizard/removeshortcuts.sh</program>
                  <programArguments>"${installdir}"</programArguments>
                </runProgram>
            </actionList>
            <ruleList>
                <compareText>
                    <logic>contains</logic>
                    <text>${platform_name}</text>
                    <value>linux</value>
                </compareText>
            </ruleList>
        </actionGroup>
    </preUninstallationActionList>
   
    <!-- Components -->
    <componentList>
        <component>
            <name>MigrationWizard</name>
            <description>MigrationWizard</description>
            <canBeEdited>0</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <folderList>
                
                <!-- LINUX: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfilesbinlinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
                        <distributionFile>
                            <origin>staging/linux/MigrationWizard/MigrationWizard.jar</origin>
                        </distributionFile>
			<distributionDirectory>
                            <origin>staging/linux/MigrationWizard/lib</origin>
                        </distributionDirectory>
                    </distributionFileList>
		</folder>
 		<folder>
		    <description>Installation Files</description>
                    <destination>${installdir}</destination>
                    <name>installfileslinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
			<distributionDirectory>
                            <origin>staging/linux/installer</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Launch And Menu Scripts</description>
                    <destination>${installdir}</destination>
                    <name>menuandlaunchfileslinux</name>
                    <platforms>linux</platforms>
                    <distributionFileList>
			<distributionDirectory>
                            <origin>staging/linux/scripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
		 </folder>

                 <!-- WIN: Program files -->
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionFile>
                            <origin>staging/windows/MigrationWizard/MigrationWizard.jar</origin>
                        </distributionFile>
                        <distributionDirectory>
                            <origin>staging/windows/MigrationWizard/lib</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Installation Files</description>
                    <destination>${installdir}</destination>
                    <name>installfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/windows/installer</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <description>Launch And Menu Scripts</description>
                    <destination>${installdir}</destination>
                    <name>menuandlaunchfileswindows</name>
                    <platforms>windows</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>staging/windows/scripts</origin>
                        </distributionDirectory>
                    </distributionFileList>
                 </folder>
 
                
            </folderList>

            <!-- WIN: Start Menu -->
            <startMenuShortcutList>
                <!-- Launch MigrationWizard -->
                <startMenuShortcut>
                     <comment>MigrationWizard</comment>
                     <name>MigrationWizard</name>
                     <runInTerminal>0</runInTerminal>
                     <windowsExec>wscript</windowsExec>
                     <windowsExecArgs>//NoLogo "${installdir}\scripts\launchMigrationWizard.vbs&quot; &quot;&quot; &quot;${java_executable}&quot; &quot;-jar MigrationWizard.jar&quot; &quot;${installdir}&quot;"</windowsExecArgs>
                     <windowsIcon>${installdir}\scripts\images\application.ico</windowsIcon>
                </startMenuShortcut>
            </startMenuShortcutList>
            
       </component>
    </componentList>

    <finalPageActionList>
        <runProgram>
            <abortOnError>0</abortOnError>
            <program>wscript</program>
            <programArguments>//nologo &quot;${installdir}\\scripts\\launchMigrationWizard.vbs&quot; &quot;&quot; &quot;${java_executable}&quot; &quot;-jar MigrationWizard.jar&quot; &quot;${installdir}&quot;</programArguments>
            <progressText>${msg(launch.migrationwizard.windows)}</progressText>
            <showMessageOnError>0</showMessageOnError>
            <ruleList>
	        <compareText>
	            <logic>contains</logic>
		    <text>${platform_name}</text>
		    <value>windows</value>
		</compareText>		  
            </ruleList>
        </runProgram>
    </finalPageActionList>
   
    <parameterList>

        <!-- Install Directory -->
        <directoryParameter>
            <name>installdir</name>
            <description>Installer.Parameter.installdir.description</description>
            <explanation>Installer.Parameter.installdir.explanation</explanation>
            <value>${platform_install_prefix}/PostgreSQL/EnterpriseDB-${product_shortname}</value>
            <default>${platform_install_prefix}/PostgreSQL/EnterpriseDB-${product_shortname}</default>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>prefix</cliOptionName>
            <mustBeWritable>yes</mustBeWritable>
            <mustExist>0</mustExist>
            <width>40</width>
            <ruleList>
                <compareText>
                   <text>${MigrationWizardVersion}</text>
                   <logic>equals</logic>
                   <value></value>
                </compareText>
            </ruleList>

            <!-- Validating whether installdir contains whitespaces (Linux) -->
            <validationActionList>
                <actionGroup>
                  <actionList>
                     <throwError>
                           <text>${msg(migrationwizard.installdir.error)}</text>
                     </throwError>
                  </actionList>
                  <ruleList>
                    <regExMatch>
                        <text>${installdir}</text>
                        <logic>matches</logic>
                        <pattern>^.*\s.*$</pattern>
                    </regExMatch>
                    <compareText>
                        <text>${platform_name}</text>
                        <logic>contains</logic>
                        <value>linux</value>
                    </compareText>
                  </ruleList>
               </actionGroup>
            </validationActionList>
        </directoryParameter>        
    </parameterList>
</project>

